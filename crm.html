<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovaMind CRM — Calendar &amp; Client Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; color: #1e293b; height: 100vh; display: flex; overflow: hidden; }

    /* ── Sidebar ── */
    .sidebar {
      width: 260px;
      background: #0f172a;
      color: #94a3b8;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-brand {
      padding: 24px 20px;
      border-bottom: 1px solid #1e293b;
    }
    .sidebar-brand h1 { font-size: 1.25rem; color: #2563eb; font-weight: 700; }
    .sidebar-brand h1 span { color: #fff; }
    .sidebar-brand p { font-size: .75rem; margin-top: 4px; color: #64748b; }
    .sidebar-nav { flex: 1; padding: 16px 12px; }
    .sidebar-nav button {
      display: flex; align-items: center; gap: 12px;
      width: 100%; padding: 12px 16px;
      background: none; border: none; color: #94a3b8;
      font-family: inherit; font-size: .9rem; font-weight: 500;
      border-radius: 8px; cursor: pointer; transition: .15s; text-align: left;
    }
    .sidebar-nav button:hover { background: #1e293b; color: #e2e8f0; }
    .sidebar-nav button.active { background: #2563eb; color: #fff; }
    .sidebar-nav button .icon { font-size: 1.1rem; width: 24px; text-align: center; }
    .sidebar-nav button .badge {
      margin-left: auto;
      background: #ef4444;
      color: #fff;
      font-size: .7rem;
      padding: 2px 7px;
      border-radius: 10px;
      font-weight: 600;
    }
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid #1e293b;
      font-size: .8rem;
    }

    /* ── Main ── */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* ── Top bar ── */
    .topbar {
      background: #fff;
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
    }
    .topbar h2 { font-size: 1.2rem; font-weight: 700; }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      padding: 9px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: .15s;
    }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }
    .btn-secondary:hover { background: #e2e8f0; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }
    .btn-sm { padding: 6px 14px; font-size: .8rem; }
    .search-box {
      padding: 8px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: .85rem;
      font-family: inherit;
      outline: none;
      width: 220px;
      transition: border-color .2s;
    }
    .search-box:focus { border-color: #2563eb; }

    /* ── Content ── */
    .content { flex: 1; overflow-y: auto; padding: 24px 28px; }

    /* ── Calendar ── */
    .cal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .cal-header h3 { font-size: 1.3rem; font-weight: 700; }
    .cal-nav { display: flex; gap: 8px; }
    .cal-nav button {
      width: 36px; height: 36px;
      border-radius: 8px; border: 1px solid #e2e8f0;
      background: #fff; cursor: pointer; font-size: 1rem;
      display: flex; align-items: center; justify-content: center;
      transition: .15s;
    }
    .cal-nav button:hover { background: #f1f5f9; }
    .cal-view-toggle { display: flex; gap: 4px; background: #f1f5f9; border-radius: 8px; padding: 3px; }
    .cal-view-toggle button {
      padding: 6px 16px; border: none; background: none;
      font-family: inherit; font-size: .8rem; font-weight: 600;
      color: #64748b; border-radius: 6px; cursor: pointer; transition: .15s;
    }
    .cal-view-toggle button.active { background: #fff; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,.1); }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }
    .cal-day-header {
      padding: 10px;
      text-align: center;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .cal-cell {
      min-height: 100px;
      padding: 6px 8px;
      border-right: 1px solid #f1f5f9;
      border-bottom: 1px solid #f1f5f9;
      cursor: pointer;
      transition: background .1s;
      position: relative;
    }
    .cal-cell:hover { background: #f8fafc; }
    .cal-cell:nth-child(7n) { border-right: none; }
    .cal-cell .day-num {
      font-size: .8rem;
      font-weight: 600;
      color: #64748b;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .cal-cell.today .day-num { background: #2563eb; color: #fff; }
    .cal-cell.other-month .day-num { color: #cbd5e1; }
    .cal-cell.other-month { background: #fafbfc; }
    .cal-event {
      margin-top: 3px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: .7rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    .cal-event.meeting { background: #dbeafe; color: #1d4ed8; }
    .cal-event.call { background: #dcfce7; color: #16a34a; }
    .cal-event.deadline { background: #fee2e2; color: #dc2626; }
    .cal-event.followup { background: #fef3c7; color: #d97706; }

    /* ── Week view ── */
    .week-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }
    .week-header-cell {
      padding: 10px 6px;
      text-align: center;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      border-right: 1px solid #f1f5f9;
    }
    .week-header-cell .day-num-w { font-size: 1.1rem; color: #1e293b; margin-top: 2px; }
    .week-header-cell.today-col .day-num-w {
      background: #2563eb; color: #fff;
      width: 30px; height: 30px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .week-time-col {
      padding: 4px 8px;
      font-size: .7rem;
      color: #94a3b8;
      text-align: right;
      border-right: 1px solid #e2e8f0;
      height: 48px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
    }
    .week-cell {
      height: 48px;
      border-right: 1px solid #f1f5f9;
      border-bottom: 1px solid #f1f5f9;
      padding: 1px 3px;
      cursor: pointer;
      position: relative;
    }
    .week-cell:hover { background: #f8fafc; }
    .week-event {
      padding: 2px 5px;
      border-radius: 4px;
      font-size: .65rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .week-event.meeting { background: #dbeafe; color: #1d4ed8; }
    .week-event.call { background: #dcfce7; color: #16a34a; }
    .week-event.deadline { background: #fee2e2; color: #dc2626; }
    .week-event.followup { background: #fef3c7; color: #d97706; }

    /* ── Client list ── */
    .client-table {
      width: 100%;
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }
    .client-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }
    .client-table td {
      padding: 14px 16px;
      font-size: .9rem;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    .client-table tr:last-child td { border-bottom: none; }
    .client-table tr:hover td { background: #f8fafc; }
    .client-avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: .8rem;
      margin-right: 10px; vertical-align: middle;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: .75rem;
      font-weight: 600;
    }
    .status-active { background: #dcfce7; color: #16a34a; }
    .status-lead { background: #dbeafe; color: #2563eb; }
    .status-prospect { background: #fef3c7; color: #d97706; }
    .status-inactive { background: #f1f5f9; color: #64748b; }

    /* ── Dashboard ── */
    .dash-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }
    .dash-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
    }
    .dash-card .label { font-size: .8rem; color: #64748b; font-weight: 500; }
    .dash-card .value { font-size: 1.8rem; font-weight: 700; margin-top: 4px; }
    .dash-card .change { font-size: .8rem; margin-top: 4px; }
    .dash-card .up { color: #16a34a; }
    .dash-card .down { color: #dc2626; }
    .dash-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .dash-section {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px;
    }
    .dash-section h4 { font-size: .95rem; font-weight: 700; margin-bottom: 14px; }
    .upcoming-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .upcoming-item:last-child { border-bottom: none; }
    .upcoming-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .upcoming-item .time { font-size: .75rem; color: #94a3b8; min-width: 60px; }
    .upcoming-item .title { font-size: .85rem; font-weight: 600; }
    .upcoming-item .client { font-size: .75rem; color: #64748b; }
    .pipeline-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .pipeline-item:last-child { border-bottom: none; }
    .pipeline-item .name { font-size: .85rem; font-weight: 600; }
    .pipeline-item .stage { font-size: .75rem; color: #64748b; }
    .pipeline-item .amount { font-weight: 700; color: #2563eb; font-size: .9rem; }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      width: 480px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .modal h3 { font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label {
      display: block;
      font-size: .8rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      font-size: .9rem;
      outline: none;
      transition: border-color .2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color: #2563eb; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

    /* ── Responsive ── */
    @media (max-width: 1024px) {
      .dash-cards { grid-template-columns: repeat(2, 1fr); }
      .dash-sections { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .dash-cards { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <h1>Nova<span>Mind</span></h1>
      <p>CRM &amp; Calendar</p>
    </div>
    <nav class="sidebar-nav">
      <button class="active" data-view="dashboard"><span class="icon">&#x1F4CA;</span> Dashboard</button>
      <button data-view="calendar"><span class="icon">&#x1F4C5;</span> Calendar</button>
      <button data-view="clients"><span class="icon">&#x1F465;</span> Clients</button>
    </nav>
    <div class="sidebar-footer">&copy; 2026 NovaMind AI</div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h2 id="viewTitle">Dashboard</h2>
      <div class="topbar-actions">
        <input type="text" class="search-box" id="searchBox" placeholder="Search...">
        <button class="btn btn-primary" id="addBtn">+ New Event</button>
      </div>
    </div>
    <div class="content" id="content"></div>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <h3 id="modalTitle">New Event</h3>
      <form id="eventForm">
        <input type="hidden" id="eventId">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="eventTitleInput" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="eventDate" required>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="time" id="eventTime" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <select id="eventType">
              <option value="meeting">Meeting</option>
              <option value="call">Call</option>
              <option value="deadline">Deadline</option>
              <option value="followup">Follow-up</option>
            </select>
          </div>
          <div class="form-group">
            <label>Client</label>
            <select id="eventClient">
              <option value="">— None —</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="eventNotes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" class="btn btn-secondary" id="cancelEventBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Client Modal -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <h3 id="clientModalTitle">New Client</h3>
      <form id="clientForm">
        <input type="hidden" id="clientId">
        <div class="form-row">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="clientName" required>
          </div>
          <div class="form-group">
            <label>Company</label>
            <input type="text" id="clientCompany">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="clientEmail" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="clientPhone">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="clientStatus">
              <option value="lead">Lead</option>
              <option value="prospect">Prospect</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Deal Value</label>
            <input type="number" id="clientValue" placeholder="$0">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="clientNotes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteClientBtn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" class="btn btn-secondary" id="cancelClientBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
// ── State (persisted in localStorage) ──
const STORAGE_KEY = 'novamind_crm';
let state = loadState();

function defaultState() {
  const today = new Date();
  const d = (offset) => {
    const dt = new Date(today);
    dt.setDate(dt.getDate() + offset);
    return dt.toISOString().slice(0, 10);
  };
  return {
    clients: [
      { id: c_id(), name: 'Sarah Robinson', company: 'Meridian Logistics', email: 'sarah@meridian.com', phone: '(555) 100-2000', status: 'active', value: 85000, notes: 'Interested in process automation for warehouse ops.' },
      { id: c_id(), name: 'James Kim', company: 'BrightPath Health', email: 'jkim@brightpath.com', phone: '(555) 200-3000', status: 'active', value: 120000, notes: 'AI strategy engagement — 3 year roadmap.' },
      { id: c_id(), name: 'Maria Lopez', company: 'FinEdge Capital', email: 'mlopez@finedge.com', phone: '(555) 300-4000', status: 'active', value: 95000, notes: 'Custom forecasting model in production.' },
      { id: c_id(), name: 'David Chen', company: 'Atlas Retail', email: 'dchen@atlas.com', phone: '(555) 400-5000', status: 'lead', value: 60000, notes: 'Exploratory — wants demand forecasting.' },
      { id: c_id(), name: 'Emily Parker', company: 'Greenline Energy', email: 'eparker@greenline.com', phone: '(555) 500-6000', status: 'prospect', value: 45000, notes: 'Referred by James Kim.' },
      { id: c_id(), name: 'Robert Tanaka', company: 'Apex Manufacturing', email: 'rtanaka@apex.com', phone: '(555) 600-7000', status: 'inactive', value: 0, notes: 'Previous engagement completed Q3 2025.' },
    ],
    events: [
      { id: c_id(), title: 'Strategy kickoff — BrightPath', date: d(0), time: '10:00', type: 'meeting', clientName: 'James Kim', notes: '' },
      { id: c_id(), title: 'Follow up — Atlas Retail', date: d(1), time: '14:00', type: 'followup', clientName: 'David Chen', notes: 'Send proposal draft' },
      { id: c_id(), title: 'Weekly sync — Meridian', date: d(2), time: '09:30', type: 'call', clientName: 'Sarah Robinson', notes: '' },
      { id: c_id(), title: 'Proposal deadline — Greenline', date: d(3), time: '17:00', type: 'deadline', clientName: 'Emily Parker', notes: '' },
      { id: c_id(), title: 'Demo — FinEdge model v2', date: d(4), time: '11:00', type: 'meeting', clientName: 'Maria Lopez', notes: '' },
      { id: c_id(), title: 'Quarterly review prep', date: d(5), time: '13:00', type: 'meeting', clientName: '', notes: 'Internal' },
      { id: c_id(), title: 'Check in — David Chen', date: d(7), time: '10:30', type: 'call', clientName: 'David Chen', notes: '' },
      { id: c_id(), title: 'Contract renewal — Meridian', date: d(10), time: '15:00', type: 'deadline', clientName: 'Sarah Robinson', notes: '' },
    ],
    calYear: today.getFullYear(),
    calMonth: today.getMonth(),
    calView: 'month',
    currentView: 'dashboard',
  };
}

function c_id() { return '_' + Math.random().toString(36).slice(2, 10); }
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch {}
  return defaultState();
}
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// ── Navigation ──
const navBtns = document.querySelectorAll('.sidebar-nav button');
const viewTitle = document.getElementById('viewTitle');
const content = document.getElementById('content');
const addBtn = document.getElementById('addBtn');
const searchBox = document.getElementById('searchBox');

navBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    navBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.currentView = btn.dataset.view;
    saveState();
    render();
  });
});

addBtn.addEventListener('click', () => {
  if (state.currentView === 'clients') openClientModal();
  else openEventModal();
});

searchBox.addEventListener('input', render);

function render() {
  const v = state.currentView;
  viewTitle.textContent = v === 'dashboard' ? 'Dashboard' : v === 'calendar' ? 'Calendar' : 'Clients';
  addBtn.textContent = v === 'clients' ? '+ New Client' : '+ New Event';
  if (v === 'dashboard') renderDashboard();
  else if (v === 'calendar') renderCalendar();
  else renderClients();
}

// ── Dashboard ──
function renderDashboard() {
  const activeClients = state.clients.filter(c => c.status === 'active').length;
  const totalValue = state.clients.reduce((s, c) => s + (c.value || 0), 0);
  const upcoming = [...state.events].sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time)).filter(e => e.date >= new Date().toISOString().slice(0, 10)).slice(0, 6);
  const pipeline = state.clients.filter(c => c.status !== 'inactive' && c.value > 0).sort((a, b) => b.value - a.value).slice(0, 5);

  content.innerHTML = `
    <div class="dash-cards">
      <div class="dash-card"><div class="label">Total Clients</div><div class="value">${state.clients.length}</div></div>
      <div class="dash-card"><div class="label">Active Clients</div><div class="value">${activeClients}</div></div>
      <div class="dash-card"><div class="label">Upcoming Events</div><div class="value">${upcoming.length}</div></div>
      <div class="dash-card"><div class="label">Pipeline Value</div><div class="value">$${(totalValue/1000).toFixed(0)}k</div></div>
    </div>
    <div class="dash-sections">
      <div class="dash-section">
        <h4>Upcoming Events</h4>
        ${upcoming.map(e => `
          <div class="upcoming-item" style="cursor:pointer" data-eid="${e.id}">
            <div class="upcoming-dot" style="background:${typeColor(e.type)}"></div>
            <div class="time">${formatDate(e.date)}<br>${e.time}</div>
            <div><div class="title">${esc(e.title)}</div><div class="client">${esc(e.clientName || '—')}</div></div>
          </div>
        `).join('') || '<p style="color:#94a3b8;font-size:.9rem;">No upcoming events</p>'}
      </div>
      <div class="dash-section">
        <h4>Pipeline</h4>
        ${pipeline.map(c => `
          <div class="pipeline-item" style="cursor:pointer" data-cid="${c.id}">
            <div><div class="name">${esc(c.name)}</div><div class="stage">${esc(c.company)} &middot; <span class="status-badge status-${c.status}">${c.status}</span></div></div>
            <div class="amount">$${c.value.toLocaleString()}</div>
          </div>
        `).join('') || '<p style="color:#94a3b8;font-size:.9rem;">No pipeline data</p>'}
      </div>
    </div>
  `;
  content.querySelectorAll('[data-eid]').forEach(el => {
    el.addEventListener('click', () => openEventModal(el.dataset.eid));
  });
  content.querySelectorAll('[data-cid]').forEach(el => {
    el.addEventListener('click', () => openClientModal(el.dataset.cid));
  });
}

function typeColor(t) {
  return { meeting: '#2563eb', call: '#16a34a', deadline: '#dc2626', followup: '#d97706' }[t] || '#64748b';
}

function formatDate(d) {
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ── Calendar ──
function renderCalendar() {
  const year = state.calYear;
  const month = state.calMonth;
  const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const q = searchBox.value.toLowerCase();

  let viewToggle = `
    <div class="cal-view-toggle">
      <button class="${state.calView === 'month' ? 'active' : ''}" data-cv="month">Month</button>
      <button class="${state.calView === 'week' ? 'active' : ''}" data-cv="week">Week</button>
    </div>`;

  let html = `
    <div class="cal-header">
      <div class="cal-nav">
        <button id="calPrev">&#9664;</button>
        <button id="calNext">&#9654;</button>
      </div>
      <h3>${monthName}</h3>
      ${viewToggle}
    </div>`;

  if (state.calView === 'month') {
    html += renderMonthView(year, month, q);
  } else {
    html += renderWeekView(q);
  }

  content.innerHTML = html;

  document.getElementById('calPrev').addEventListener('click', () => {
    if (state.calView === 'month') {
      state.calMonth--;
      if (state.calMonth < 0) { state.calMonth = 11; state.calYear--; }
    } else {
      state.calWeekStart = new Date(state.calWeekStart);
      state.calWeekStart.setDate(state.calWeekStart.getDate() - 7);
      state.calWeekStart = state.calWeekStart.toISOString().slice(0, 10);
    }
    saveState(); renderCalendar();
  });
  document.getElementById('calNext').addEventListener('click', () => {
    if (state.calView === 'month') {
      state.calMonth++;
      if (state.calMonth > 11) { state.calMonth = 0; state.calYear++; }
    } else {
      state.calWeekStart = new Date(state.calWeekStart);
      state.calWeekStart.setDate(state.calWeekStart.getDate() + 7);
      state.calWeekStart = state.calWeekStart.toISOString().slice(0, 10);
    }
    saveState(); renderCalendar();
  });

  content.querySelectorAll('[data-cv]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.calView = btn.dataset.cv;
      if (state.calView === 'week' && !state.calWeekStart) {
        const today = new Date();
        const day = today.getDay();
        const sun = new Date(today);
        sun.setDate(today.getDate() - day);
        state.calWeekStart = sun.toISOString().slice(0, 10);
      }
      saveState(); renderCalendar();
    });
  });

  content.querySelectorAll('.cal-cell').forEach(cell => {
    cell.addEventListener('click', (e) => {
      if (e.target.closest('.cal-event')) return;
      const d = cell.dataset.date;
      if (d) openEventModal(null, d);
    });
  });
  content.querySelectorAll('.week-cell').forEach(cell => {
    cell.addEventListener('click', (e) => {
      if (e.target.closest('.week-event')) return;
      const d = cell.dataset.date;
      const t = cell.dataset.time;
      if (d) openEventModal(null, d, t);
    });
  });
  content.querySelectorAll('.cal-event, .week-event').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      openEventModal(el.dataset.eid);
    });
  });
}

function renderMonthView(year, month, q) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const today = new Date().toISOString().slice(0, 10);
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;

  let html = '<div class="cal-grid">';
  days.forEach(d => { html += `<div class="cal-day-header">${d}</div>`; });

  for (let i = 0; i < totalCells; i++) {
    let day, dateStr, cls = '';
    if (i < firstDay) {
      day = daysInPrev - firstDay + i + 1;
      const pm = month === 0 ? 11 : month - 1;
      const py = month === 0 ? year - 1 : year;
      dateStr = `${py}-${String(pm + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      cls = 'other-month';
    } else if (i >= firstDay + daysInMonth) {
      day = i - firstDay - daysInMonth + 1;
      const nm = month === 11 ? 0 : month + 1;
      const ny = month === 11 ? year + 1 : year;
      dateStr = `${ny}-${String(nm + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      cls = 'other-month';
    } else {
      day = i - firstDay + 1;
      dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    if (dateStr === today) cls += ' today';

    const evts = state.events
      .filter(e => e.date === dateStr && (!q || e.title.toLowerCase().includes(q) || (e.clientName || '').toLowerCase().includes(q)))
      .sort((a, b) => a.time.localeCompare(b.time));

    html += `<div class="cal-cell ${cls}" data-date="${dateStr}">
      <div class="day-num">${day}</div>
      ${evts.slice(0, 3).map(e => `<div class="cal-event ${e.type}" data-eid="${e.id}">${e.time.slice(0,5)} ${esc(e.title)}</div>`).join('')}
      ${evts.length > 3 ? `<div style="font-size:.65rem;color:#64748b;padding:2px 6px;">+${evts.length - 3} more</div>` : ''}
    </div>`;
  }
  html += '</div>';
  return html;
}

function renderWeekView(q) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const today = new Date().toISOString().slice(0, 10);
  let ws = state.calWeekStart ? new Date(state.calWeekStart + 'T00:00:00') : new Date();
  if (!state.calWeekStart) {
    ws.setDate(ws.getDate() - ws.getDay());
    state.calWeekStart = ws.toISOString().slice(0, 10);
  }
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(ws);
    d.setDate(ws.getDate() + i);
    weekDates.push(d.toISOString().slice(0, 10));
  }

  const hours = [];
  for (let h = 7; h <= 19; h++) hours.push(h);

  let html = '<div class="week-grid">';
  html += '<div class="week-header-cell"></div>';
  weekDates.forEach((d, i) => {
    const dn = new Date(d + 'T00:00:00').getDate();
    const isToday = d === today;
    html += `<div class="week-header-cell ${isToday ? 'today-col' : ''}">${days[i]}<br><span class="day-num-w${isToday ? ' today-col' : ''}">${dn}</span></div>`;
  });

  hours.forEach(h => {
    const label = h <= 12 ? `${h} ${h < 12 ? 'AM' : 'PM'}` : `${h - 12} PM`;
    html += `<div class="week-time-col">${label}</div>`;
    weekDates.forEach(d => {
      const hStr = String(h).padStart(2, '0');
      const evts = state.events.filter(e => e.date === d && e.time.startsWith(hStr) && (!q || e.title.toLowerCase().includes(q) || (e.clientName || '').toLowerCase().includes(q)));
      html += `<div class="week-cell" data-date="${d}" data-time="${hStr}:00">
        ${evts.map(e => `<div class="week-event ${e.type}" data-eid="${e.id}">${esc(e.title)}</div>`).join('')}
      </div>`;
    });
  });
  html += '</div>';
  return html;
}

// ── Clients ──
function renderClients() {
  const q = searchBox.value.toLowerCase();
  const filtered = state.clients.filter(c =>
    !q || c.name.toLowerCase().includes(q) || c.company.toLowerCase().includes(q) || c.email.toLowerCase().includes(q) || c.status.includes(q)
  );
  const colors = ['#dbeafe', '#dcfce7', '#fef3c7', '#fee2e2', '#ede9fe', '#fce7f3'];

  content.innerHTML = `
    <table class="client-table">
      <thead><tr>
        <th>Client</th><th>Company</th><th>Email</th><th>Status</th><th>Value</th><th></th>
      </tr></thead>
      <tbody>
        ${filtered.map((c, i) => `
          <tr>
            <td>
              <span class="client-avatar" style="background:${colors[i % colors.length]};color:${typeColor('meeting')}">${initials(c.name)}</span>
              ${esc(c.name)}
            </td>
            <td>${esc(c.company)}</td>
            <td>${esc(c.email)}</td>
            <td><span class="status-badge status-${c.status}">${c.status}</span></td>
            <td style="font-weight:600">${c.value ? '$' + c.value.toLocaleString() : '—'}</td>
            <td><button class="btn btn-secondary btn-sm" data-cid="${c.id}">Edit</button></td>
          </tr>
        `).join('')}
        ${filtered.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:40px;">No clients found</td></tr>' : ''}
      </tbody>
    </table>
  `;
  content.querySelectorAll('[data-cid]').forEach(btn => {
    btn.addEventListener('click', () => openClientModal(btn.dataset.cid));
  });
}

function initials(name) {
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

// ── Event Modal ──
function openEventModal(id, prefillDate, prefillTime) {
  const modal = document.getElementById('eventModal');
  const form = document.getElementById('eventForm');
  const delBtn = document.getElementById('deleteEventBtn');
  document.getElementById('modalTitle').textContent = id ? 'Edit Event' : 'New Event';
  form.reset();
  document.getElementById('eventId').value = '';
  delBtn.style.display = 'none';

  // populate client dropdown
  const sel = document.getElementById('eventClient');
  sel.innerHTML = '<option value="">— None —</option>' + state.clients.map(c => `<option value="${esc(c.name)}">${esc(c.name)} (${esc(c.company)})</option>`).join('');

  if (id) {
    const ev = state.events.find(e => e.id === id);
    if (ev) {
      document.getElementById('eventId').value = ev.id;
      document.getElementById('eventTitleInput').value = ev.title;
      document.getElementById('eventDate').value = ev.date;
      document.getElementById('eventTime').value = ev.time;
      document.getElementById('eventType').value = ev.type;
      document.getElementById('eventClient').value = ev.clientName || '';
      document.getElementById('eventNotes').value = ev.notes || '';
      delBtn.style.display = '';
    }
  } else {
    const now = new Date();
    document.getElementById('eventDate').value = prefillDate || now.toISOString().slice(0, 10);
    document.getElementById('eventTime').value = prefillTime || `${String(now.getHours()).padStart(2,'0')}:00`;
  }
  modal.classList.add('open');
}

document.getElementById('eventForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = document.getElementById('eventId').value;
  const data = {
    title: document.getElementById('eventTitleInput').value,
    date: document.getElementById('eventDate').value,
    time: document.getElementById('eventTime').value,
    type: document.getElementById('eventType').value,
    clientName: document.getElementById('eventClient').value,
    notes: document.getElementById('eventNotes').value,
  };
  if (id) {
    const ev = state.events.find(e => e.id === id);
    if (ev) Object.assign(ev, data);
  } else {
    state.events.push({ id: c_id(), ...data });
  }
  saveState();
  document.getElementById('eventModal').classList.remove('open');
  render();
});

document.getElementById('deleteEventBtn').addEventListener('click', () => {
  const id = document.getElementById('eventId').value;
  state.events = state.events.filter(e => e.id !== id);
  saveState();
  document.getElementById('eventModal').classList.remove('open');
  render();
});

document.getElementById('cancelEventBtn').addEventListener('click', () => {
  document.getElementById('eventModal').classList.remove('open');
});

// ── Client Modal ──
function openClientModal(id) {
  const modal = document.getElementById('clientModal');
  const form = document.getElementById('clientForm');
  const delBtn = document.getElementById('deleteClientBtn');
  document.getElementById('clientModalTitle').textContent = id ? 'Edit Client' : 'New Client';
  form.reset();
  document.getElementById('clientId').value = '';
  delBtn.style.display = 'none';

  if (id) {
    const cl = state.clients.find(c => c.id === id);
    if (cl) {
      document.getElementById('clientId').value = cl.id;
      document.getElementById('clientName').value = cl.name;
      document.getElementById('clientCompany').value = cl.company;
      document.getElementById('clientEmail').value = cl.email;
      document.getElementById('clientPhone').value = cl.phone || '';
      document.getElementById('clientStatus').value = cl.status;
      document.getElementById('clientValue').value = cl.value || '';
      document.getElementById('clientNotes').value = cl.notes || '';
      delBtn.style.display = '';
    }
  }
  modal.classList.add('open');
}

document.getElementById('clientForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = document.getElementById('clientId').value;
  const data = {
    name: document.getElementById('clientName').value,
    company: document.getElementById('clientCompany').value,
    email: document.getElementById('clientEmail').value,
    phone: document.getElementById('clientPhone').value,
    status: document.getElementById('clientStatus').value,
    value: Number(document.getElementById('clientValue').value) || 0,
    notes: document.getElementById('clientNotes').value,
  };
  if (id) {
    const cl = state.clients.find(c => c.id === id);
    if (cl) Object.assign(cl, data);
  } else {
    state.clients.push({ id: c_id(), ...data });
  }
  saveState();
  document.getElementById('clientModal').classList.remove('open');
  render();
});

document.getElementById('deleteClientBtn').addEventListener('click', () => {
  const id = document.getElementById('clientId').value;
  state.events.forEach(e => {
    const cl = state.clients.find(c => c.id === id);
    if (cl && e.clientName === cl.name) e.clientName = '';
  });
  state.clients = state.clients.filter(c => c.id !== id);
  saveState();
  document.getElementById('clientModal').classList.remove('open');
  render();
});

document.getElementById('cancelClientBtn').addEventListener('click', () => {
  document.getElementById('clientModal').classList.remove('open');
});

// Close modals on overlay click
['eventModal', 'clientModal'].forEach(id => {
  document.getElementById(id).addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

// ── Helpers ──
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ── Init ──
// Restore active nav
navBtns.forEach(b => {
  b.classList.toggle('active', b.dataset.view === state.currentView);
});
render();
</script>
</body>
</html>
