<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovaMind CRM — Cannabis Retail Client Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f1f5f4; color: #1e293b; height: 100vh; display: flex; overflow: hidden; }

    /* ── Sidebar ── */
    .sidebar {
      width: 260px;
      background: #14201a;
      color: #94a3b8;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-brand {
      padding: 24px 20px;
      border-bottom: 1px solid #1e3328;
    }
    .sidebar-brand h1 { font-size: 1.25rem; color: #22c55e; font-weight: 700; }
    .sidebar-brand h1 span { color: #fff; }
    .sidebar-brand p { font-size: .75rem; margin-top: 4px; color: #64748b; }
    .sidebar-nav { flex: 1; padding: 16px 12px; }
    .sidebar-nav button {
      display: flex; align-items: center; gap: 12px;
      width: 100%; padding: 12px 16px;
      background: none; border: none; color: #94a3b8;
      font-family: inherit; font-size: .9rem; font-weight: 500;
      border-radius: 8px; cursor: pointer; transition: .15s; text-align: left;
    }
    .sidebar-nav button:hover { background: #1e3328; color: #e2e8f0; }
    .sidebar-nav button.active { background: #16a34a; color: #fff; }
    .sidebar-nav button .icon { font-size: 1.1rem; width: 24px; text-align: center; }
    .sidebar-nav button .badge {
      margin-left: auto;
      background: #ef4444;
      color: #fff;
      font-size: .7rem;
      padding: 2px 7px;
      border-radius: 10px;
      font-weight: 600;
    }
    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid #1e3328;
      font-size: .8rem;
    }

    /* ── Main ── */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* ── Top bar ── */
    .topbar {
      background: #fff;
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #d4e8d9;
      flex-shrink: 0;
    }
    .topbar h2 { font-size: 1.2rem; font-weight: 700; }
    .topbar-actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      padding: 9px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: .85rem;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: .15s;
    }
    .btn-primary { background: #16a34a; color: #fff; }
    .btn-primary:hover { background: #15803d; }
    .btn-secondary { background: #f1f5f4; color: #475569; border: 1px solid #d4e8d9; }
    .btn-secondary:hover { background: #e2efe6; }
    .btn-danger { background: #fee2e2; color: #dc2626; }
    .btn-danger:hover { background: #fecaca; }
    .btn-sm { padding: 6px 14px; font-size: .8rem; }
    .search-box {
      padding: 8px 14px;
      border: 1px solid #d4e8d9;
      border-radius: 8px;
      font-size: .85rem;
      font-family: inherit;
      outline: none;
      width: 220px;
      transition: border-color .2s;
    }
    .search-box:focus { border-color: #16a34a; }

    /* ── Content ── */
    .content { flex: 1; overflow-y: auto; padding: 24px 28px; }

    /* ── Calendar ── */
    .cal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .cal-header h3 { font-size: 1.3rem; font-weight: 700; }
    .cal-nav { display: flex; gap: 8px; }
    .cal-nav button {
      width: 36px; height: 36px;
      border-radius: 8px; border: 1px solid #d4e8d9;
      background: #fff; cursor: pointer; font-size: 1rem;
      display: flex; align-items: center; justify-content: center;
      transition: .15s;
    }
    .cal-nav button:hover { background: #f1f5f4; }
    .cal-view-toggle { display: flex; gap: 4px; background: #f1f5f4; border-radius: 8px; padding: 3px; }
    .cal-view-toggle button {
      padding: 6px 16px; border: none; background: none;
      font-family: inherit; font-size: .8rem; font-weight: 600;
      color: #64748b; border-radius: 6px; cursor: pointer; transition: .15s;
    }
    .cal-view-toggle button.active { background: #fff; color: #1e293b; box-shadow: 0 1px 3px rgba(0,0,0,.1); }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #d4e8d9;
      overflow: hidden;
    }
    .cal-day-header {
      padding: 10px;
      text-align: center;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      background: #f0faf2;
      border-bottom: 1px solid #d4e8d9;
    }
    .cal-cell {
      min-height: 100px;
      padding: 6px 8px;
      border-right: 1px solid #eef5f0;
      border-bottom: 1px solid #eef5f0;
      cursor: pointer;
      transition: background .1s;
      position: relative;
    }
    .cal-cell:hover { background: #f0faf2; }
    .cal-cell:nth-child(7n) { border-right: none; }
    .cal-cell .day-num {
      font-size: .8rem;
      font-weight: 600;
      color: #64748b;
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
    }
    .cal-cell.today .day-num { background: #16a34a; color: #fff; }
    .cal-cell.other-month .day-num { color: #cbd5e1; }
    .cal-cell.other-month { background: #fafcfb; }
    .cal-event {
      margin-top: 3px;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: .7rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    .cal-event.meeting { background: #dcfce7; color: #15803d; }
    .cal-event.call { background: #dbeafe; color: #1d4ed8; }
    .cal-event.deadline { background: #fee2e2; color: #dc2626; }
    .cal-event.followup { background: #fef3c7; color: #d97706; }
    .cal-event.delivery { background: #e0e7ff; color: #4338ca; }
    .cal-event.inspection { background: #fce7f3; color: #be185d; }
    .cal-event.license { background: #f3e8ff; color: #7c3aed; }

    /* ── Week view ── */
    .week-grid {
      display: grid;
      grid-template-columns: 60px repeat(7, 1fr);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #d4e8d9;
      overflow: hidden;
    }
    .week-header-cell {
      padding: 10px 6px;
      text-align: center;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      background: #f0faf2;
      border-bottom: 1px solid #d4e8d9;
      border-right: 1px solid #eef5f0;
    }
    .week-header-cell .day-num-w { font-size: 1.1rem; color: #1e293b; margin-top: 2px; }
    .week-header-cell.today-col .day-num-w {
      background: #16a34a; color: #fff;
      width: 30px; height: 30px; border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .week-time-col {
      padding: 4px 8px;
      font-size: .7rem;
      color: #94a3b8;
      text-align: right;
      border-right: 1px solid #d4e8d9;
      height: 48px;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
    }
    .week-cell {
      height: 48px;
      border-right: 1px solid #eef5f0;
      border-bottom: 1px solid #eef5f0;
      padding: 1px 3px;
      cursor: pointer;
      position: relative;
    }
    .week-cell:hover { background: #f0faf2; }
    .week-event {
      padding: 2px 5px;
      border-radius: 4px;
      font-size: .65rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .week-event.meeting { background: #dcfce7; color: #15803d; }
    .week-event.call { background: #dbeafe; color: #1d4ed8; }
    .week-event.deadline { background: #fee2e2; color: #dc2626; }
    .week-event.followup { background: #fef3c7; color: #d97706; }
    .week-event.delivery { background: #e0e7ff; color: #4338ca; }
    .week-event.inspection { background: #fce7f3; color: #be185d; }
    .week-event.license { background: #f3e8ff; color: #7c3aed; }

    /* ── Client list ── */
    .client-table {
      width: 100%;
      background: #fff;
      border-radius: 12px;
      border: 1px solid #d4e8d9;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
    }
    .client-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: .75rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      background: #f0faf2;
      border-bottom: 1px solid #d4e8d9;
    }
    .client-table td {
      padding: 14px 16px;
      font-size: .9rem;
      border-bottom: 1px solid #eef5f0;
      vertical-align: middle;
    }
    .client-table tr:last-child td { border-bottom: none; }
    .client-table tr:hover td { background: #f0faf2; }
    .client-avatar {
      width: 36px; height: 36px;
      border-radius: 50%;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: .8rem;
      margin-right: 10px; vertical-align: middle;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: .75rem;
      font-weight: 600;
    }
    .status-active { background: #dcfce7; color: #16a34a; }
    .status-lead { background: #dbeafe; color: #2563eb; }
    .status-prospect { background: #fef3c7; color: #d97706; }
    .status-inactive { background: #f1f5f9; color: #64748b; }
    .license-badge {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: .7rem;
      font-weight: 600;
    }
    .license-valid { background: #dcfce7; color: #16a34a; }
    .license-expiring { background: #fef3c7; color: #d97706; }
    .license-expired { background: #fee2e2; color: #dc2626; }

    /* ── Dashboard ── */
    .dash-cards {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }
    .dash-card {
      background: #fff;
      border: 1px solid #d4e8d9;
      border-radius: 12px;
      padding: 20px;
    }
    .dash-card .label { font-size: .8rem; color: #64748b; font-weight: 500; }
    .dash-card .value { font-size: 1.8rem; font-weight: 700; margin-top: 4px; }
    .dash-card .change { font-size: .8rem; margin-top: 4px; }
    .dash-card .up { color: #16a34a; }
    .dash-card .down { color: #dc2626; }
    .dash-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .dash-section {
      background: #fff; border: 1px solid #d4e8d9; border-radius: 12px; padding: 20px;
    }
    .dash-section h4 { font-size: .95rem; font-weight: 700; margin-bottom: 14px; }
    .upcoming-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #eef5f0;
    }
    .upcoming-item:last-child { border-bottom: none; }
    .upcoming-dot {
      width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
    }
    .upcoming-item .time { font-size: .75rem; color: #94a3b8; min-width: 60px; }
    .upcoming-item .title { font-size: .85rem; font-weight: 600; }
    .upcoming-item .client { font-size: .75rem; color: #64748b; }
    .pipeline-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eef5f0;
    }
    .pipeline-item:last-child { border-bottom: none; }
    .pipeline-item .name { font-size: .85rem; font-weight: 600; }
    .pipeline-item .stage { font-size: .75rem; color: #64748b; }
    .pipeline-item .amount { font-weight: 700; color: #16a34a; font-size: .9rem; }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.4);
      z-index: 200;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: #fff;
      border-radius: 16px;
      width: 520px;
      max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
      box-shadow: 0 20px 60px rgba(0,0,0,.2);
    }
    .modal h3 { font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 14px; }
    .form-group label {
      display: block;
      font-size: .8rem;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 5px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d4e8d9;
      border-radius: 8px;
      font-family: inherit;
      font-size: .9rem;
      outline: none;
      transition: border-color .2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus { border-color: #16a34a; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-row { display: flex; gap: 12px; }
    .form-row .form-group { flex: 1; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

    /* ── Marketing ── */
    .mkt-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
    .mkt-stat { background:#fff; border:1px solid #d4e8d9; border-radius:12px; padding:18px; }
    .mkt-stat .label { font-size:.78rem; color:#64748b; font-weight:500; }
    .mkt-stat .value { font-size:1.6rem; font-weight:700; margin-top:2px; }

    .campaign-table { width:100%; background:#fff; border-radius:12px; border:1px solid #d4e8d9; border-collapse:separate; border-spacing:0; overflow:hidden; }
    .campaign-table th { text-align:left; padding:12px 16px; font-size:.75rem; font-weight:600; color:#64748b; text-transform:uppercase; background:#f0faf2; border-bottom:1px solid #d4e8d9; }
    .campaign-table td { padding:14px 16px; font-size:.88rem; border-bottom:1px solid #eef5f0; vertical-align:middle; }
    .campaign-table tr:last-child td { border-bottom:none; }
    .campaign-table tr:hover td { background:#f0faf2; }

    .camp-status { padding:4px 10px; border-radius:20px; font-size:.73rem; font-weight:600; }
    .camp-status-draft { background:#f1f5f9; color:#64748b; }
    .camp-status-sent { background:#dcfce7; color:#16a34a; }
    .camp-status-scheduled { background:#dbeafe; color:#2563eb; }

    /* Composer */
    .composer { background:#fff; border:1px solid #d4e8d9; border-radius:12px; overflow:hidden; }
    .composer-steps { display:flex; border-bottom:1px solid #d4e8d9; background:#f0faf2; }
    .composer-step { flex:1; padding:14px 12px; text-align:center; font-size:.8rem; font-weight:600; color:#94a3b8; cursor:default; position:relative; }
    .composer-step.active { color:#16a34a; background:#fff; }
    .composer-step.done { color:#15803d; }
    .composer-step .step-num { display:inline-flex; align-items:center; justify-content:center; width:24px; height:24px; border-radius:50%; background:#e2e8f0; color:#64748b; font-size:.75rem; font-weight:700; margin-right:6px; }
    .composer-step.active .step-num { background:#16a34a; color:#fff; }
    .composer-step.done .step-num { background:#dcfce7; color:#16a34a; }
    .composer-body { padding:28px; min-height:400px; }
    .composer-footer { display:flex; justify-content:space-between; padding:16px 28px; border-top:1px solid #d4e8d9; background:#f9fafb; }

    /* Audience checkboxes */
    .audience-list { max-height:320px; overflow-y:auto; border:1px solid #d4e8d9; border-radius:8px; }
    .audience-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-bottom:1px solid #eef5f0; }
    .audience-item:last-child { border-bottom:none; }
    .audience-item:hover { background:#f0faf2; }
    .audience-item input[type="checkbox"] { width:18px; height:18px; accent-color:#16a34a; }
    .audience-filter { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
    .audience-filter button { padding:6px 14px; border-radius:20px; border:1px solid #d4e8d9; background:#fff; font-family:inherit; font-size:.78rem; font-weight:600; color:#475569; cursor:pointer; transition:.15s; }
    .audience-filter button.active { background:#16a34a; color:#fff; border-color:#16a34a; }

    /* Template cards */
    .template-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
    .template-card { border:2px solid #d4e8d9; border-radius:12px; padding:20px; cursor:pointer; transition:.15s; }
    .template-card:hover { border-color:#16a34a; background:#f0faf2; }
    .template-card.selected { border-color:#16a34a; background:#dcfce7; }
    .template-card h5 { font-size:.95rem; font-weight:700; margin-bottom:4px; }
    .template-card p { font-size:.8rem; color:#64748b; }

    /* Editor */
    .editor-split { display:grid; grid-template-columns:1fr 1fr; gap:20px; min-height:400px; }
    .editor-area { border:1px solid #d4e8d9; border-radius:8px; padding:16px; font-family:inherit; font-size:.88rem; line-height:1.6; min-height:380px; outline:none; overflow-y:auto; }
    .editor-area:focus { border-color:#16a34a; }
    .preview-frame { border:1px solid #d4e8d9; border-radius:8px; overflow:hidden; background:#f9fafb; }
    .preview-frame iframe { width:100%; height:100%; border:none; min-height:380px; }
    .editor-toolbar { display:flex; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
    .editor-toolbar button { padding:5px 10px; border:1px solid #d4e8d9; border-radius:6px; background:#fff; font-family:inherit; font-size:.78rem; cursor:pointer; transition:.15s; }
    .editor-toolbar button:hover { background:#f0faf2; border-color:#16a34a; }

    /* Review */
    .review-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    .review-details { display:flex; flex-direction:column; gap:14px; }
    .review-field { background:#f9fafb; border:1px solid #eef5f0; border-radius:8px; padding:14px; }
    .review-field .label { font-size:.75rem; font-weight:600; color:#64748b; text-transform:uppercase; margin-bottom:4px; }
    .review-field .val { font-size:.9rem; color:#1e293b; }
    .review-preview { border:1px solid #d4e8d9; border-radius:8px; overflow:hidden; }
    .review-preview iframe { width:100%; border:none; min-height:500px; }

    /* Toast */
    .toast { position:fixed; bottom:24px; right:24px; background:#14201a; color:#fff; padding:14px 24px; border-radius:10px; font-size:.9rem; font-weight:600; z-index:999; box-shadow:0 8px 30px rgba(0,0,0,.25); display:flex; align-items:center; gap:10px; animation:toastIn .3s ease; }
    .toast.success { border-left:4px solid #22c55e; }
    .toast.error { border-left:4px solid #ef4444; }
    @keyframes toastIn { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }

    /* ── Responsive ── */
    @media (max-width: 1024px) {
      .dash-cards { grid-template-columns: repeat(2, 1fr); }
      .dash-sections { grid-template-columns: 1fr; }
      .mkt-stats { grid-template-columns: repeat(2,1fr); }
      .template-grid { grid-template-columns: 1fr; }
      .editor-split { grid-template-columns: 1fr; }
      .review-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .dash-cards { grid-template-columns: 1fr; }
      .mkt-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <h1>Nova<span>Mind</span></h1>
      <p>Cannabis Retail CRM</p>
    </div>
    <nav class="sidebar-nav">
      <button class="active" data-view="dashboard"><span class="icon">&#x1F4CA;</span> Dashboard</button>
      <button data-view="calendar"><span class="icon">&#x1F4C5;</span> Calendar</button>
      <button data-view="clients"><span class="icon">&#x1F33F;</span> Dispensaries</button>
      <button data-view="marketing"><span class="icon">&#x1F4E7;</span> Marketing</button>
    </nav>
    <div class="sidebar-footer">&copy; 2026 NovaMind AI</div>
  </aside>

  <!-- Main -->
  <div class="main">
    <div class="topbar">
      <h2 id="viewTitle">Dashboard</h2>
      <div class="topbar-actions">
        <input type="text" class="search-box" id="searchBox" placeholder="Search...">
        <button class="btn btn-primary" id="addBtn">+ New Event</button>
      </div>
    </div>
    <div class="content" id="content"></div>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="eventModal">
    <div class="modal">
      <h3 id="modalTitle">New Event</h3>
      <form id="eventForm">
        <input type="hidden" id="eventId">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="eventTitleInput" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="eventDate" required>
          </div>
          <div class="form-group">
            <label>Time</label>
            <input type="time" id="eventTime" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type</label>
            <select id="eventType">
              <option value="meeting">Meeting</option>
              <option value="call">Call</option>
              <option value="delivery">Delivery</option>
              <option value="inspection">Compliance Inspection</option>
              <option value="license">License Renewal</option>
              <option value="deadline">Deadline</option>
              <option value="followup">Follow-up</option>
            </select>
          </div>
          <div class="form-group">
            <label>Client</label>
            <select id="eventClient">
              <option value="">— None —</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="eventNotes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteEventBtn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" class="btn btn-secondary" id="cancelEventBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Client Modal -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <h3 id="clientModalTitle">New Dispensary</h3>
      <form id="clientForm">
        <input type="hidden" id="clientId">
        <div class="form-row">
          <div class="form-group">
            <label>Contact Name</label>
            <input type="text" id="clientName" required>
          </div>
          <div class="form-group">
            <label>Dispensary / Company</label>
            <input type="text" id="clientCompany">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="clientEmail" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" id="clientPhone">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Status</label>
            <select id="clientStatus">
              <option value="lead">Lead</option>
              <option value="prospect">Prospect</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="form-group">
            <label>Monthly Revenue</label>
            <input type="number" id="clientValue" placeholder="$0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>License #</label>
            <input type="text" id="clientLicense" placeholder="e.g. C10-0000123-LIC">
          </div>
          <div class="form-group">
            <label>License Expiry</label>
            <input type="date" id="clientLicenseExpiry">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Store Type</label>
            <select id="clientStoreType">
              <option value="dispensary">Dispensary</option>
              <option value="delivery">Delivery Only</option>
              <option value="cultivation">Cultivation</option>
              <option value="manufacturing">Manufacturing</option>
              <option value="distribution">Distribution</option>
              <option value="microbusiness">Microbusiness</option>
            </select>
          </div>
          <div class="form-group">
            <label># of Locations</label>
            <input type="number" id="clientLocations" placeholder="1" min="1">
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="clientNotes"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" id="deleteClientBtn" style="margin-right:auto;display:none;">Delete</button>
          <button type="button" class="btn btn-secondary" id="cancelClientBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

<script>
// ── State (persisted in localStorage) ──
const STORAGE_KEY = 'novamind_cannabis_crm';
let state = loadState();

function defaultState() {
  const today = new Date();
  const d = (offset) => {
    const dt = new Date(today);
    dt.setDate(dt.getDate() + offset);
    return dt.toISOString().slice(0, 10);
  };
  const futureDate = (months) => {
    const dt = new Date(today);
    dt.setMonth(dt.getMonth() + months);
    return dt.toISOString().slice(0, 10);
  };
  return {
    clients: [
      { id: c_id(), name: 'Marcus Green', company: 'Emerald Leaf Dispensary', email: 'marcus@emeraldleaf.com', phone: '(415) 555-0142', status: 'active', value: 285000, license: 'C10-0001847-LIC', licenseExpiry: futureDate(8), storeType: 'dispensary', locations: 3, notes: 'Flagship in SF Mission District. Top-performing retail client. Interested in AI-powered inventory forecasting.' },
      { id: c_id(), name: 'Lisa Chang', company: 'Pacific Roots Cannabis', email: 'lisa@pacificroots.com', phone: '(510) 555-0298', status: 'active', value: 190000, license: 'C10-0002391-LIC', licenseExpiry: futureDate(4), storeType: 'dispensary', locations: 2, notes: 'Oakland & Berkeley locations. Wants POS analytics dashboard and customer loyalty program optimization.' },
      { id: c_id(), name: 'Jordan Rivera', company: 'High Sierra Collective', email: 'jordan@highsierra.co', phone: '(916) 555-0467', status: 'active', value: 145000, license: 'C10-0003105-LIC', licenseExpiry: futureDate(2), storeType: 'microbusiness', locations: 1, notes: 'Seed-to-sale microbusiness in Sacramento. Needs compliance tracking automation and Metrc integration.' },
      { id: c_id(), name: 'Aisha Patel', company: 'GreenWave Delivery', email: 'aisha@greenwave.delivery', phone: '(213) 555-0583', status: 'active', value: 110000, license: 'C9-0000782-LIC', licenseExpiry: futureDate(6), storeType: 'delivery', locations: 1, notes: 'Delivery-only license in LA. Route optimization and demand prediction project in progress.' },
      { id: c_id(), name: 'Derek Morrison', company: 'SunGrown Farms', email: 'derek@sungrownfarms.com', phone: '(707) 555-0331', status: 'active', value: 220000, license: 'CCL18-0000456-LIC', licenseExpiry: futureDate(10), storeType: 'cultivation', locations: 1, notes: 'Humboldt outdoor cultivation. AI yield prediction and pest detection system deployed.' },
      { id: c_id(), name: 'Natalie Woods', company: 'Bloom Room SF', email: 'natalie@bloomroomsf.com', phone: '(415) 555-0714', status: 'prospect', value: 95000, license: 'C10-0004210-LIC', licenseExpiry: futureDate(5), storeType: 'dispensary', locations: 1, notes: 'Single location on Haight St. Interested in customer analytics and menu optimization.' },
      { id: c_id(), name: 'Carlos Mendez', company: 'Verde Labs', email: 'carlos@verdelabs.com', phone: '(310) 555-0892', status: 'lead', value: 175000, license: 'CDPH-T00001234', licenseExpiry: futureDate(3), storeType: 'manufacturing', locations: 1, notes: 'Edibles & concentrate manufacturer in LA. Wants batch tracking AI and quality control automation.' },
      { id: c_id(), name: 'Tanya Brooks', company: 'Canna Coast Distribution', email: 'tanya@cannacoast.com', phone: '(831) 555-0156', status: 'lead', value: 130000, license: 'C11-0000987-LIC', licenseExpiry: futureDate(7), storeType: 'distribution', locations: 2, notes: 'Central coast distributor. Supply chain optimization and logistics AI.' },
      { id: c_id(), name: 'Ray Nakamura', company: 'Zen Garden Cannabis', email: 'ray@zengarden.com', phone: '(619) 555-0445', status: 'inactive', value: 0, license: 'C10-0002876-LIC', licenseExpiry: d(-30), storeType: 'dispensary', locations: 1, notes: 'San Diego location closed. License expired — may reopen under new ownership.' },
    ],
    events: [
      { id: c_id(), title: 'POS analytics review — Emerald Leaf', date: d(0), time: '10:00', type: 'meeting', clientName: 'Marcus Green', notes: 'Review Q1 sales data and inventory turn rates' },
      { id: c_id(), title: 'Compliance audit prep — High Sierra', date: d(1), time: '09:00', type: 'inspection', clientName: 'Jordan Rivera', notes: 'Ensure Metrc reports are up to date before state audit' },
      { id: c_id(), title: 'Delivery route optimization demo — GreenWave', date: d(1), time: '14:00', type: 'meeting', clientName: 'Aisha Patel', notes: 'Present AI routing model results' },
      { id: c_id(), title: 'Weekly inventory delivery — Pacific Roots', date: d(2), time: '08:00', type: 'delivery', clientName: 'Lisa Chang', notes: 'Oakland location restocking' },
      { id: c_id(), title: 'License renewal deadline — High Sierra', date: d(3), time: '17:00', type: 'license', clientName: 'Jordan Rivera', notes: 'State license renewal — file before EOD' },
      { id: c_id(), title: 'Follow up on proposal — Bloom Room', date: d(3), time: '11:00', type: 'followup', clientName: 'Natalie Woods', notes: 'Sent menu optimization proposal last week' },
      { id: c_id(), title: 'Yield prediction model review — SunGrown', date: d(4), time: '13:00', type: 'call', clientName: 'Derek Morrison', notes: 'Discuss model accuracy on spring harvest predictions' },
      { id: c_id(), title: 'Verde Labs intro call', date: d(5), time: '10:30', type: 'call', clientName: 'Carlos Mendez', notes: 'Initial discovery — manufacturing AI needs' },
      { id: c_id(), title: 'Canna Coast supply chain workshop', date: d(7), time: '09:00', type: 'meeting', clientName: 'Tanya Brooks', notes: 'Full-day workshop mapping distribution workflows' },
      { id: c_id(), title: 'State compliance inspection — Emerald Leaf', date: d(8), time: '10:00', type: 'inspection', clientName: 'Marcus Green', notes: 'BCC scheduled inspection — all 3 locations' },
      { id: c_id(), title: 'Quarterly business review — Pacific Roots', date: d(10), time: '14:00', type: 'meeting', clientName: 'Lisa Chang', notes: 'QBR: review AI ROI metrics and plan next quarter' },
      { id: c_id(), title: 'Delivery batch — GreenWave restock', date: d(12), time: '07:00', type: 'delivery', clientName: 'Aisha Patel', notes: 'Bi-weekly product restock delivery' },
    ],
    calYear: today.getFullYear(),
    calMonth: today.getMonth(),
    calView: 'month',
    currentView: 'dashboard',
    campaigns: [
      { id: c_id(), name: 'New Strain Drop: Blue Dream Haze', subject: 'Just Dropped: Blue Dream Haze — Limited Supply', previewText: 'Be the first to stock the hottest new hybrid strain', templateId: 'strain-drop', html: '', recipients: [], status: 'sent', sentAt: d(-5), scheduledFor: null, stats: { sent: 8, opened: 6, clicked: 3 } },
      { id: c_id(), name: 'Weekly Deals — Feb 10-16', subject: 'This Week\'s Hottest Deals Inside', previewText: '20% off select edibles + BOGO pre-rolls', templateId: 'weekly-deals', html: '', recipients: [], status: 'sent', sentAt: d(-3), scheduledFor: null, stats: { sent: 7, opened: 5, clicked: 2 } },
      { id: c_id(), name: 'Valentine\'s Day Flash Sale', subject: 'FLASH SALE: 30% Off All Vape Cartridges — Today Only', previewText: 'Show your customers some love with these deals', templateId: 'flash-sale', html: '', recipients: [], status: 'scheduled', sentAt: null, scheduledFor: d(1), stats: { sent: 0, opened: 0, clicked: 0 } },
      { id: c_id(), name: 'New Menu Highlight: Edibles Collection', subject: 'Check Out Our Premium Edibles Lineup', previewText: 'Curated selection of artisan edibles now available', templateId: 'menu-highlight', html: '', recipients: [], status: 'draft', sentAt: null, scheduledFor: null, stats: { sent: 0, opened: 0, clicked: 0 } },
    ],
  };
}

function c_id() { return '_' + Math.random().toString(36).slice(2, 10); }
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch {}
  return defaultState();
}
function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

// ── Navigation ──
const navBtns = document.querySelectorAll('.sidebar-nav button');
const viewTitle = document.getElementById('viewTitle');
const content = document.getElementById('content');
const addBtn = document.getElementById('addBtn');
const searchBox = document.getElementById('searchBox');

navBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    navBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.currentView = btn.dataset.view;
    saveState();
    render();
  });
});

addBtn.addEventListener('click', () => {
  if (state.currentView === 'clients') openClientModal();
  else if (state.currentView === 'marketing') openCampaignComposer();
  else openEventModal();
});

searchBox.addEventListener('input', render);

function render() {
  const v = state.currentView;
  const titles = { dashboard:'Dashboard', calendar:'Calendar', clients:'Dispensaries', marketing:'Marketing' };
  viewTitle.textContent = titles[v] || 'Dashboard';
  const btnLabels = { clients:'+ New Dispensary', marketing:'+ New Campaign', dashboard:'+ New Event', calendar:'+ New Event' };
  addBtn.textContent = btnLabels[v] || '+ New Event';
  if (v === 'dashboard') renderDashboard();
  else if (v === 'calendar') renderCalendar();
  else if (v === 'marketing') renderMarketing();
  else renderClients();
}

// ── Dashboard ──
function renderDashboard() {
  const activeClients = state.clients.filter(c => c.status === 'active').length;
  const totalLocations = state.clients.filter(c => c.status === 'active').reduce((s, c) => s + (c.locations || 1), 0);
  const totalRevenue = state.clients.filter(c => c.status === 'active').reduce((s, c) => s + (c.value || 0), 0);
  const upcoming = [...state.events].sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time)).filter(e => e.date >= new Date().toISOString().slice(0, 10)).slice(0, 6);

  // License alerts
  const today = new Date().toISOString().slice(0, 10);
  const soon = new Date();
  soon.setDate(soon.getDate() + 90);
  const soonStr = soon.toISOString().slice(0, 10);
  const licenseAlerts = state.clients.filter(c => c.licenseExpiry && c.status !== 'inactive' && c.licenseExpiry <= soonStr).sort((a, b) => a.licenseExpiry.localeCompare(b.licenseExpiry));

  const pipeline = state.clients.filter(c => c.status !== 'inactive' && c.value > 0).sort((a, b) => b.value - a.value).slice(0, 5);

  content.innerHTML = `
    <div class="dash-cards">
      <div class="dash-card"><div class="label">Active Clients</div><div class="value">${activeClients}</div><div class="change"><span class="up">${totalLocations} locations</span></div></div>
      <div class="dash-card"><div class="label">Monthly Revenue</div><div class="value" style="color:#16a34a">$${(totalRevenue/1000).toFixed(0)}k</div></div>
      <div class="dash-card"><div class="label">Upcoming Events</div><div class="value">${upcoming.length}</div></div>
      <div class="dash-card"><div class="label">License Alerts</div><div class="value" style="color:${licenseAlerts.length > 0 ? '#d97706' : '#16a34a'}">${licenseAlerts.length}</div><div class="change">${licenseAlerts.length > 0 ? '<span class="down">Expiring within 90 days</span>' : '<span class="up">All clear</span>'}</div></div>
    </div>
    <div class="dash-sections">
      <div class="dash-section">
        <h4>Upcoming Events</h4>
        ${upcoming.map(e => `
          <div class="upcoming-item" style="cursor:pointer" data-eid="${e.id}">
            <div class="upcoming-dot" style="background:${typeColor(e.type)}"></div>
            <div class="time">${formatDate(e.date)}<br>${e.time}</div>
            <div><div class="title">${esc(e.title)}</div><div class="client">${esc(e.clientName || '—')}</div></div>
          </div>
        `).join('') || '<p style="color:#94a3b8;font-size:.9rem;">No upcoming events</p>'}
      </div>
      <div class="dash-section">
        <h4>License Renewals &amp; Pipeline</h4>
        ${licenseAlerts.length > 0 ? licenseAlerts.map(c => {
          const expired = c.licenseExpiry < today;
          const cls = expired ? 'license-expired' : 'license-expiring';
          const label = expired ? 'EXPIRED' : 'Expiring ' + formatDate(c.licenseExpiry);
          return `<div class="pipeline-item" style="cursor:pointer" data-cid="${c.id}">
            <div><div class="name">${esc(c.company)}</div><div class="stage">${esc(c.license || '—')}</div></div>
            <span class="license-badge ${cls}">${label}</span>
          </div>`;
        }).join('') : ''}
        <div style="margin-top:${licenseAlerts.length > 0 ? '16px;padding-top:12px;border-top:1px solid #eef5f0' : '0'}">
          ${licenseAlerts.length > 0 ? '<h4 style="font-size:.9rem;margin-bottom:10px;">Top Accounts</h4>' : ''}
          ${pipeline.map(c => `
            <div class="pipeline-item" style="cursor:pointer" data-cid="${c.id}">
              <div><div class="name">${esc(c.company)}</div><div class="stage">${esc(c.name)} &middot; <span class="status-badge status-${c.status}">${c.status}</span></div></div>
              <div class="amount">$${c.value.toLocaleString()}/mo</div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  content.querySelectorAll('[data-eid]').forEach(el => {
    el.addEventListener('click', () => openEventModal(el.dataset.eid));
  });
  content.querySelectorAll('[data-cid]').forEach(el => {
    el.addEventListener('click', () => openClientModal(el.dataset.cid));
  });
}

function typeColor(t) {
  return { meeting: '#16a34a', call: '#2563eb', deadline: '#dc2626', followup: '#d97706', delivery: '#4338ca', inspection: '#be185d', license: '#7c3aed' }[t] || '#64748b';
}

function formatDate(d) {
  const dt = new Date(d + 'T00:00:00');
  return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ── Calendar ──
function renderCalendar() {
  const year = state.calYear;
  const month = state.calMonth;
  const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const q = searchBox.value.toLowerCase();

  let viewToggle = `
    <div class="cal-view-toggle">
      <button class="${state.calView === 'month' ? 'active' : ''}" data-cv="month">Month</button>
      <button class="${state.calView === 'week' ? 'active' : ''}" data-cv="week">Week</button>
    </div>`;

  let html = `
    <div class="cal-header">
      <div class="cal-nav">
        <button id="calPrev">&#9664;</button>
        <button id="calNext">&#9654;</button>
      </div>
      <h3>${monthName}</h3>
      ${viewToggle}
    </div>`;

  if (state.calView === 'month') {
    html += renderMonthView(year, month, q);
  } else {
    html += renderWeekView(q);
  }

  content.innerHTML = html;

  document.getElementById('calPrev').addEventListener('click', () => {
    if (state.calView === 'month') {
      state.calMonth--;
      if (state.calMonth < 0) { state.calMonth = 11; state.calYear--; }
    } else {
      state.calWeekStart = new Date(state.calWeekStart);
      state.calWeekStart.setDate(state.calWeekStart.getDate() - 7);
      state.calWeekStart = state.calWeekStart.toISOString().slice(0, 10);
    }
    saveState(); renderCalendar();
  });
  document.getElementById('calNext').addEventListener('click', () => {
    if (state.calView === 'month') {
      state.calMonth++;
      if (state.calMonth > 11) { state.calMonth = 0; state.calYear++; }
    } else {
      state.calWeekStart = new Date(state.calWeekStart);
      state.calWeekStart.setDate(state.calWeekStart.getDate() + 7);
      state.calWeekStart = state.calWeekStart.toISOString().slice(0, 10);
    }
    saveState(); renderCalendar();
  });

  content.querySelectorAll('[data-cv]').forEach(btn => {
    btn.addEventListener('click', () => {
      state.calView = btn.dataset.cv;
      if (state.calView === 'week' && !state.calWeekStart) {
        const today = new Date();
        const day = today.getDay();
        const sun = new Date(today);
        sun.setDate(today.getDate() - day);
        state.calWeekStart = sun.toISOString().slice(0, 10);
      }
      saveState(); renderCalendar();
    });
  });

  content.querySelectorAll('.cal-cell').forEach(cell => {
    cell.addEventListener('click', (e) => {
      if (e.target.closest('.cal-event')) return;
      const d = cell.dataset.date;
      if (d) openEventModal(null, d);
    });
  });
  content.querySelectorAll('.week-cell').forEach(cell => {
    cell.addEventListener('click', (e) => {
      if (e.target.closest('.week-event')) return;
      const d = cell.dataset.date;
      const t = cell.dataset.time;
      if (d) openEventModal(null, d, t);
    });
  });
  content.querySelectorAll('.cal-event, .week-event').forEach(el => {
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      openEventModal(el.dataset.eid);
    });
  });
}

function renderMonthView(year, month, q) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const today = new Date().toISOString().slice(0, 10);
  const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;

  let html = '<div class="cal-grid">';
  days.forEach(d => { html += `<div class="cal-day-header">${d}</div>`; });

  for (let i = 0; i < totalCells; i++) {
    let day, dateStr, cls = '';
    if (i < firstDay) {
      day = daysInPrev - firstDay + i + 1;
      const pm = month === 0 ? 11 : month - 1;
      const py = month === 0 ? year - 1 : year;
      dateStr = `${py}-${String(pm + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      cls = 'other-month';
    } else if (i >= firstDay + daysInMonth) {
      day = i - firstDay - daysInMonth + 1;
      const nm = month === 11 ? 0 : month + 1;
      const ny = month === 11 ? year + 1 : year;
      dateStr = `${ny}-${String(nm + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      cls = 'other-month';
    } else {
      day = i - firstDay + 1;
      dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    if (dateStr === today) cls += ' today';

    const evts = state.events
      .filter(e => e.date === dateStr && (!q || e.title.toLowerCase().includes(q) || (e.clientName || '').toLowerCase().includes(q)))
      .sort((a, b) => a.time.localeCompare(b.time));

    html += `<div class="cal-cell ${cls}" data-date="${dateStr}">
      <div class="day-num">${day}</div>
      ${evts.slice(0, 3).map(e => `<div class="cal-event ${e.type}" data-eid="${e.id}">${e.time.slice(0,5)} ${esc(e.title)}</div>`).join('')}
      ${evts.length > 3 ? `<div style="font-size:.65rem;color:#64748b;padding:2px 6px;">+${evts.length - 3} more</div>` : ''}
    </div>`;
  }
  html += '</div>';
  return html;
}

function renderWeekView(q) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const today = new Date().toISOString().slice(0, 10);
  let ws = state.calWeekStart ? new Date(state.calWeekStart + 'T00:00:00') : new Date();
  if (!state.calWeekStart) {
    ws.setDate(ws.getDate() - ws.getDay());
    state.calWeekStart = ws.toISOString().slice(0, 10);
  }
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(ws);
    d.setDate(ws.getDate() + i);
    weekDates.push(d.toISOString().slice(0, 10));
  }

  const hours = [];
  for (let h = 7; h <= 19; h++) hours.push(h);

  let html = '<div class="week-grid">';
  html += '<div class="week-header-cell"></div>';
  weekDates.forEach((d, i) => {
    const dn = new Date(d + 'T00:00:00').getDate();
    const isToday = d === today;
    html += `<div class="week-header-cell ${isToday ? 'today-col' : ''}">${days[i]}<br><span class="day-num-w${isToday ? ' today-col' : ''}">${dn}</span></div>`;
  });

  hours.forEach(h => {
    const label = h <= 12 ? `${h} ${h < 12 ? 'AM' : 'PM'}` : `${h - 12} PM`;
    html += `<div class="week-time-col">${label}</div>`;
    weekDates.forEach(d => {
      const hStr = String(h).padStart(2, '0');
      const evts = state.events.filter(e => e.date === d && e.time.startsWith(hStr) && (!q || e.title.toLowerCase().includes(q) || (e.clientName || '').toLowerCase().includes(q)));
      html += `<div class="week-cell" data-date="${d}" data-time="${hStr}:00">
        ${evts.map(e => `<div class="week-event ${e.type}" data-eid="${e.id}">${esc(e.title)}</div>`).join('')}
      </div>`;
    });
  });
  html += '</div>';
  return html;
}

// ── Clients ──
function renderClients() {
  const q = searchBox.value.toLowerCase();
  const filtered = state.clients.filter(c =>
    !q || c.name.toLowerCase().includes(q) || c.company.toLowerCase().includes(q) || c.email.toLowerCase().includes(q) || c.status.includes(q) || (c.storeType || '').toLowerCase().includes(q) || (c.license || '').toLowerCase().includes(q)
  );
  const colors = ['#dcfce7', '#dbeafe', '#fef3c7', '#fee2e2', '#f3e8ff', '#fce7f3', '#e0e7ff', '#ccfbf1', '#fef9c3'];
  const today = new Date().toISOString().slice(0, 10);
  const soon = new Date();
  soon.setDate(soon.getDate() + 90);
  const soonStr = soon.toISOString().slice(0, 10);

  content.innerHTML = `
    <table class="client-table">
      <thead><tr>
        <th>Contact</th><th>Dispensary</th><th>Type</th><th>License</th><th>Status</th><th>Revenue</th><th></th>
      </tr></thead>
      <tbody>
        ${filtered.map((c, i) => {
          let licCls = 'license-valid', licLabel = 'Valid';
          if (c.licenseExpiry) {
            if (c.licenseExpiry < today) { licCls = 'license-expired'; licLabel = 'Expired'; }
            else if (c.licenseExpiry <= soonStr) { licCls = 'license-expiring'; licLabel = 'Exp ' + formatDate(c.licenseExpiry); }
          }
          const typeLabels = { dispensary: 'Dispensary', delivery: 'Delivery', cultivation: 'Cultivation', manufacturing: 'Mfg', distribution: 'Distro', microbusiness: 'Micro' };
          return `
          <tr>
            <td>
              <span class="client-avatar" style="background:${colors[i % colors.length]};color:#15803d">${initials(c.name)}</span>
              ${esc(c.name)}
            </td>
            <td>${esc(c.company)}${c.locations > 1 ? ` <span style="color:#64748b;font-size:.75rem;">(${c.locations} loc)</span>` : ''}</td>
            <td><span style="font-size:.8rem;color:#475569;">${typeLabels[c.storeType] || c.storeType || '—'}</span></td>
            <td><span class="license-badge ${licCls}">${licLabel}</span><br><span style="font-size:.7rem;color:#94a3b8;">${esc(c.license || '—')}</span></td>
            <td><span class="status-badge status-${c.status}">${c.status}</span></td>
            <td style="font-weight:600">${c.value ? '$' + c.value.toLocaleString() + '/mo' : '—'}</td>
            <td><button class="btn btn-secondary btn-sm" data-cid="${c.id}">Edit</button></td>
          </tr>`;
        }).join('')}
        ${filtered.length === 0 ? '<tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:40px;">No dispensaries found</td></tr>' : ''}
      </tbody>
    </table>
  `;
  content.querySelectorAll('[data-cid]').forEach(btn => {
    btn.addEventListener('click', () => openClientModal(btn.dataset.cid));
  });
}

function initials(name) {
  return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
}

// ── Event Modal ──
function openEventModal(id, prefillDate, prefillTime) {
  const modal = document.getElementById('eventModal');
  const form = document.getElementById('eventForm');
  const delBtn = document.getElementById('deleteEventBtn');
  document.getElementById('modalTitle').textContent = id ? 'Edit Event' : 'New Event';
  form.reset();
  document.getElementById('eventId').value = '';
  delBtn.style.display = 'none';

  const sel = document.getElementById('eventClient');
  sel.innerHTML = '<option value="">— None —</option>' + state.clients.map(c => `<option value="${esc(c.name)}">${esc(c.name)} — ${esc(c.company)}</option>`).join('');

  if (id) {
    const ev = state.events.find(e => e.id === id);
    if (ev) {
      document.getElementById('eventId').value = ev.id;
      document.getElementById('eventTitleInput').value = ev.title;
      document.getElementById('eventDate').value = ev.date;
      document.getElementById('eventTime').value = ev.time;
      document.getElementById('eventType').value = ev.type;
      document.getElementById('eventClient').value = ev.clientName || '';
      document.getElementById('eventNotes').value = ev.notes || '';
      delBtn.style.display = '';
    }
  } else {
    const now = new Date();
    document.getElementById('eventDate').value = prefillDate || now.toISOString().slice(0, 10);
    document.getElementById('eventTime').value = prefillTime || `${String(now.getHours()).padStart(2,'0')}:00`;
  }
  modal.classList.add('open');
}

document.getElementById('eventForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = document.getElementById('eventId').value;
  const data = {
    title: document.getElementById('eventTitleInput').value,
    date: document.getElementById('eventDate').value,
    time: document.getElementById('eventTime').value,
    type: document.getElementById('eventType').value,
    clientName: document.getElementById('eventClient').value,
    notes: document.getElementById('eventNotes').value,
  };
  if (id) {
    const ev = state.events.find(e => e.id === id);
    if (ev) Object.assign(ev, data);
  } else {
    state.events.push({ id: c_id(), ...data });
  }
  saveState();
  document.getElementById('eventModal').classList.remove('open');
  render();
});

document.getElementById('deleteEventBtn').addEventListener('click', () => {
  const id = document.getElementById('eventId').value;
  state.events = state.events.filter(e => e.id !== id);
  saveState();
  document.getElementById('eventModal').classList.remove('open');
  render();
});

document.getElementById('cancelEventBtn').addEventListener('click', () => {
  document.getElementById('eventModal').classList.remove('open');
});

// ── Client Modal ──
function openClientModal(id) {
  const modal = document.getElementById('clientModal');
  const form = document.getElementById('clientForm');
  const delBtn = document.getElementById('deleteClientBtn');
  document.getElementById('clientModalTitle').textContent = id ? 'Edit Dispensary' : 'New Dispensary';
  form.reset();
  document.getElementById('clientId').value = '';
  delBtn.style.display = 'none';

  if (id) {
    const cl = state.clients.find(c => c.id === id);
    if (cl) {
      document.getElementById('clientId').value = cl.id;
      document.getElementById('clientName').value = cl.name;
      document.getElementById('clientCompany').value = cl.company;
      document.getElementById('clientEmail').value = cl.email;
      document.getElementById('clientPhone').value = cl.phone || '';
      document.getElementById('clientStatus').value = cl.status;
      document.getElementById('clientValue').value = cl.value || '';
      document.getElementById('clientLicense').value = cl.license || '';
      document.getElementById('clientLicenseExpiry').value = cl.licenseExpiry || '';
      document.getElementById('clientStoreType').value = cl.storeType || 'dispensary';
      document.getElementById('clientLocations').value = cl.locations || 1;
      document.getElementById('clientNotes').value = cl.notes || '';
      delBtn.style.display = '';
    }
  }
  modal.classList.add('open');
}

document.getElementById('clientForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const id = document.getElementById('clientId').value;
  const data = {
    name: document.getElementById('clientName').value,
    company: document.getElementById('clientCompany').value,
    email: document.getElementById('clientEmail').value,
    phone: document.getElementById('clientPhone').value,
    status: document.getElementById('clientStatus').value,
    value: Number(document.getElementById('clientValue').value) || 0,
    license: document.getElementById('clientLicense').value,
    licenseExpiry: document.getElementById('clientLicenseExpiry').value,
    storeType: document.getElementById('clientStoreType').value,
    locations: Number(document.getElementById('clientLocations').value) || 1,
    notes: document.getElementById('clientNotes').value,
  };
  if (id) {
    const cl = state.clients.find(c => c.id === id);
    if (cl) Object.assign(cl, data);
  } else {
    state.clients.push({ id: c_id(), ...data });
  }
  saveState();
  document.getElementById('clientModal').classList.remove('open');
  render();
});

document.getElementById('deleteClientBtn').addEventListener('click', () => {
  const id = document.getElementById('clientId').value;
  state.events.forEach(e => {
    const cl = state.clients.find(c => c.id === id);
    if (cl && e.clientName === cl.name) e.clientName = '';
  });
  state.clients = state.clients.filter(c => c.id !== id);
  saveState();
  document.getElementById('clientModal').classList.remove('open');
  render();
});

document.getElementById('cancelClientBtn').addEventListener('click', () => {
  document.getElementById('clientModal').classList.remove('open');
});

// Close modals on overlay click
['eventModal', 'clientModal'].forEach(id => {
  document.getElementById(id).addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

// Ensure campaigns array exists on legacy state
if (!state.campaigns) { state.campaigns = defaultState().campaigns; saveState(); }

// ── Email Templates ──
const EMAIL_TEMPLATES = [
  {
    id: 'strain-drop',
    name: 'New Strain Drop',
    desc: 'Announce a hot new strain arrival to your dispensary partners',
    html: `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:0;background:#f1f5f4;font-family:Arial,Helvetica,sans-serif;">
<table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f4;padding:40px 0;">
<tr><td align="center">
<table width="600" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:12px;overflow:hidden;">
  <tr><td style="background:linear-gradient(135deg,#14201a,#1e3328);padding:40px 40px 30px;text-align:center;">
    <h1 style="color:#22c55e;margin:0;font-size:28px;">NovaMind</h1>
    <p style="color:#94a3b8;margin:8px 0 0;font-size:14px;">Cannabis Retail Partner Update</p>
  </td></tr>
  <tr><td style="padding:40px;">
    <div style="background:#f0fdf4;border-left:4px solid #22c55e;padding:16px 20px;border-radius:0 8px 8px 0;margin-bottom:24px;">
      <p style="margin:0;color:#15803d;font-weight:bold;font-size:13px;text-transform:uppercase;letter-spacing:1px;">NEW STRAIN ALERT</p>
    </div>
    <h2 style="color:#1e293b;margin:0 0 12px;font-size:24px;">Blue Dream Haze</h2>
    <p style="color:#64748b;font-size:15px;line-height:1.6;margin:0 0 20px;">A premium sativa-dominant hybrid with 28% THC. Notes of sweet berry and earthy pine. This strain is flying off shelves — limited allocation available for wholesale partners.</p>
    <table cellpadding="0" cellspacing="0" style="margin-bottom:24px;width:100%;">
      <tr>
        <td style="background:#f9fafb;padding:12px 16px;border-radius:8px 0 0 8px;border:1px solid #e2e8f0;"><span style="font-size:12px;color:#64748b;">THC</span><br><strong style="color:#1e293b;">28%</strong></td>
        <td style="background:#f9fafb;padding:12px 16px;border:1px solid #e2e8f0;border-left:none;"><span style="font-size:12px;color:#64748b;">Type</span><br><strong style="color:#1e293b;">Sativa Hybrid</strong></td>
        <td style="background:#f9fafb;padding:12px 16px;border:1px solid #e2e8f0;border-left:none;"><span style="font-size:12px;color:#64748b;">Wholesale</span><br><strong style="color:#16a34a;">$2,400/lb</strong></td>
        <td style="background:#f9fafb;padding:12px 16px;border-radius:0 8px 8px 0;border:1px solid #e2e8f0;border-left:none;"><span style="font-size:12px;color:#64748b;">MOQ</span><br><strong style="color:#1e293b;">1 lb</strong></td>
      </tr>
    </table>
    <table cellpadding="0" cellspacing="0"><tr><td style="background:#16a34a;border-radius:8px;padding:14px 32px;text-align:center;">
      <a href="#" style="color:#ffffff;text-decoration:none;font-weight:bold;font-size:15px;">Reserve Your Allocation</a>
    </td></tr></table>
  </td></tr>
  <tr><td style="background:#f9fafb;padding:24px 40px;text-align:center;border-top:1px solid #e2e8f0;">
    <p style="color:#94a3b8;font-size:12px;margin:0;">NovaMind Cannabis Retail CRM &bull; <a href="#" style="color:#16a34a;">Unsubscribe</a></p>
  </td></tr>
</table>
</td></tr></table></body></html>`
  },
  {
    id: 'weekly-deals',
    name: 'Weekly Deals',
    desc: 'Highlight this week\'s best deals for your dispensary partners',
    html: `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:0;background:#f1f5f4;font-family:Arial,Helvetica,sans-serif;">
<table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f4;padding:40px 0;">
<tr><td align="center">
<table width="600" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:12px;overflow:hidden;">
  <tr><td style="background:linear-gradient(135deg,#14201a,#1e3328);padding:40px 40px 30px;text-align:center;">
    <h1 style="color:#22c55e;margin:0;font-size:28px;">NovaMind</h1>
    <p style="color:#94a3b8;margin:8px 0 0;font-size:14px;">Weekly Wholesale Deals</p>
  </td></tr>
  <tr><td style="padding:40px;">
    <h2 style="color:#1e293b;margin:0 0 8px;font-size:22px;">This Week's Hottest Deals</h2>
    <p style="color:#64748b;font-size:14px;margin:0 0 28px;">Exclusive pricing for NovaMind retail partners — valid through Sunday.</p>
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:16px;">
      <tr><td style="background:#f0fdf4;padding:16px 20px;border-radius:8px;border:1px solid #dcfce7;">
        <table width="100%"><tr>
          <td><strong style="color:#1e293b;font-size:16px;">OG Kush Pre-Rolls (10pk)</strong><br><span style="color:#64748b;font-size:13px;">Premium hand-rolled, 1g each</span></td>
          <td align="right"><span style="color:#dc2626;font-size:13px;text-decoration:line-through;">$85</span><br><strong style="color:#16a34a;font-size:20px;">$68</strong><span style="color:#64748b;font-size:12px;">/unit</span></td>
        </tr></table>
      </td></tr>
    </table>
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:16px;">
      <tr><td style="background:#f0fdf4;padding:16px 20px;border-radius:8px;border:1px solid #dcfce7;">
        <table width="100%"><tr>
          <td><strong style="color:#1e293b;font-size:16px;">Gummy Bears 100mg (Assorted)</strong><br><span style="color:#64748b;font-size:13px;">Best-selling edible, 10x10mg</span></td>
          <td align="right"><span style="color:#dc2626;font-size:13px;text-decoration:line-through;">$24</span><br><strong style="color:#16a34a;font-size:20px;">$18</strong><span style="color:#64748b;font-size:12px;">/unit</span></td>
        </tr></table>
      </td></tr>
    </table>
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:28px;">
      <tr><td style="background:#f0fdf4;padding:16px 20px;border-radius:8px;border:1px solid #dcfce7;">
        <table width="100%"><tr>
          <td><strong style="color:#1e293b;font-size:16px;">Live Resin Cartridge 1g</strong><br><span style="color:#64748b;font-size:13px;">Gelato strain, 92% THC</span></td>
          <td align="right"><span style="color:#dc2626;font-size:13px;text-decoration:line-through;">$32</span><br><strong style="color:#16a34a;font-size:20px;">$25</strong><span style="color:#64748b;font-size:12px;">/unit</span></td>
        </tr></table>
      </td></tr>
    </table>
    <table cellpadding="0" cellspacing="0" width="100%"><tr><td align="center"><table><tr><td style="background:#16a34a;border-radius:8px;padding:14px 32px;">
      <a href="#" style="color:#ffffff;text-decoration:none;font-weight:bold;font-size:15px;">Place Wholesale Order</a>
    </td></tr></table></td></tr></table>
  </td></tr>
  <tr><td style="background:#f9fafb;padding:24px 40px;text-align:center;border-top:1px solid #e2e8f0;">
    <p style="color:#94a3b8;font-size:12px;margin:0;">NovaMind Cannabis Retail CRM &bull; <a href="#" style="color:#16a34a;">Unsubscribe</a></p>
  </td></tr>
</table>
</td></tr></table></body></html>`
  },
  {
    id: 'flash-sale',
    name: 'Flash Sale',
    desc: 'Urgent limited-time offer to drive immediate wholesale orders',
    html: `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:0;background:#f1f5f4;font-family:Arial,Helvetica,sans-serif;">
<table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f4;padding:40px 0;">
<tr><td align="center">
<table width="600" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:12px;overflow:hidden;">
  <tr><td style="background:linear-gradient(135deg,#7c2d12,#dc2626);padding:40px;text-align:center;">
    <p style="color:#fecaca;margin:0 0 8px;font-size:14px;font-weight:bold;text-transform:uppercase;letter-spacing:2px;">Flash Sale — Today Only</p>
    <h1 style="color:#ffffff;margin:0;font-size:42px;">30% OFF</h1>
    <p style="color:#fecaca;margin:8px 0 0;font-size:16px;">All Vape Cartridges</p>
  </td></tr>
  <tr><td style="padding:40px;">
    <h2 style="color:#1e293b;margin:0 0 12px;font-size:20px;text-align:center;">Limited Time Wholesale Pricing</h2>
    <p style="color:#64748b;font-size:14px;line-height:1.6;text-align:center;margin:0 0 28px;">Pass these savings to your customers or boost your margins — either way, stock up now before midnight.</p>
    <table width="100%" cellpadding="0" cellspacing="0" style="background:#fef2f2;border:2px dashed #fca5a5;border-radius:8px;padding:20px;margin-bottom:24px;">
      <tr><td align="center">
        <p style="margin:0;font-size:13px;color:#dc2626;font-weight:bold;text-transform:uppercase;">Use Code</p>
        <p style="margin:6px 0 0;font-size:28px;font-weight:bold;color:#dc2626;letter-spacing:4px;">FLASH30</p>
      </td></tr>
    </table>
    <table cellpadding="0" cellspacing="0" width="100%"><tr><td align="center"><table><tr><td style="background:#dc2626;border-radius:8px;padding:14px 40px;">
      <a href="#" style="color:#ffffff;text-decoration:none;font-weight:bold;font-size:15px;">Shop the Sale Now</a>
    </td></tr></table></td></tr></table>
  </td></tr>
  <tr><td style="background:#f9fafb;padding:24px 40px;text-align:center;border-top:1px solid #e2e8f0;">
    <p style="color:#94a3b8;font-size:12px;margin:0;">NovaMind Cannabis Retail CRM &bull; <a href="#" style="color:#16a34a;">Unsubscribe</a></p>
  </td></tr>
</table>
</td></tr></table></body></html>`
  },
  {
    id: 'menu-highlight',
    name: 'Menu Highlight',
    desc: 'Showcase curated products from your catalog',
    html: `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"></head><body style="margin:0;padding:0;background:#f1f5f4;font-family:Arial,Helvetica,sans-serif;">
<table width="100%" cellpadding="0" cellspacing="0" style="background:#f1f5f4;padding:40px 0;">
<tr><td align="center">
<table width="600" cellpadding="0" cellspacing="0" style="background:#ffffff;border-radius:12px;overflow:hidden;">
  <tr><td style="background:linear-gradient(135deg,#14201a,#1e3328);padding:40px 40px 30px;text-align:center;">
    <h1 style="color:#22c55e;margin:0;font-size:28px;">NovaMind</h1>
    <p style="color:#94a3b8;margin:8px 0 0;font-size:14px;">Menu Highlights</p>
  </td></tr>
  <tr><td style="padding:40px;">
    <h2 style="color:#1e293b;margin:0 0 8px;font-size:22px;">Curated Collection: Premium Edibles</h2>
    <p style="color:#64748b;font-size:14px;margin:0 0 28px;line-height:1.6;">Hand-selected products trending across our top-performing dispensary partners this month.</p>
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:12px;">
      <tr>
        <td width="48%" style="background:#f9fafb;padding:20px;border-radius:8px;border:1px solid #e2e8f0;vertical-align:top;">
          <div style="width:100%;height:100px;background:#f0fdf4;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;text-align:center;line-height:100px;font-size:32px;">&#127851;</div>
          <strong style="color:#1e293b;font-size:14px;">Artisan Chocolate Truffles</strong><br>
          <span style="color:#64748b;font-size:12px;">50mg THC &bull; 10-pack</span><br>
          <strong style="color:#16a34a;font-size:16px;margin-top:4px;display:inline-block;">$32/unit</strong>
        </td>
        <td width="4%"></td>
        <td width="48%" style="background:#f9fafb;padding:20px;border-radius:8px;border:1px solid #e2e8f0;vertical-align:top;">
          <div style="width:100%;height:100px;background:#f0fdf4;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;text-align:center;line-height:100px;font-size:32px;">&#127855;</div>
          <strong style="color:#1e293b;font-size:14px;">Tropical Gummy Rings</strong><br>
          <span style="color:#64748b;font-size:12px;">100mg THC &bull; 20-pack</span><br>
          <strong style="color:#16a34a;font-size:16px;margin-top:4px;display:inline-block;">$22/unit</strong>
        </td>
      </tr>
    </table>
    <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom:28px;">
      <tr>
        <td width="48%" style="background:#f9fafb;padding:20px;border-radius:8px;border:1px solid #e2e8f0;vertical-align:top;">
          <div style="width:100%;height:100px;background:#f0fdf4;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;text-align:center;line-height:100px;font-size:32px;">&#9749;</div>
          <strong style="color:#1e293b;font-size:14px;">CBD Infused Coffee Pods</strong><br>
          <span style="color:#64748b;font-size:12px;">25mg CBD &bull; 12-pack</span><br>
          <strong style="color:#16a34a;font-size:16px;margin-top:4px;display:inline-block;">$28/unit</strong>
        </td>
        <td width="4%"></td>
        <td width="48%" style="background:#f9fafb;padding:20px;border-radius:8px;border:1px solid #e2e8f0;vertical-align:top;">
          <div style="width:100%;height:100px;background:#f0fdf4;border-radius:6px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;text-align:center;line-height:100px;font-size:32px;">&#127852;</div>
          <strong style="color:#1e293b;font-size:14px;">Honey Lavender Drops</strong><br>
          <span style="color:#64748b;font-size:12px;">75mg THC &bull; 30ml</span><br>
          <strong style="color:#16a34a;font-size:16px;margin-top:4px;display:inline-block;">$18/unit</strong>
        </td>
      </tr>
    </table>
    <table cellpadding="0" cellspacing="0" width="100%"><tr><td align="center"><table><tr><td style="background:#16a34a;border-radius:8px;padding:14px 32px;">
      <a href="#" style="color:#ffffff;text-decoration:none;font-weight:bold;font-size:15px;">View Full Menu</a>
    </td></tr></table></td></tr></table>
  </td></tr>
  <tr><td style="background:#f9fafb;padding:24px 40px;text-align:center;border-top:1px solid #e2e8f0;">
    <p style="color:#94a3b8;font-size:12px;margin:0;">NovaMind Cannabis Retail CRM &bull; <a href="#" style="color:#16a34a;">Unsubscribe</a></p>
  </td></tr>
</table>
</td></tr></table></body></html>`
  }
];

// ── Marketing View ──
function renderMarketing() {
  const campaigns = state.campaigns || [];
  const sent = campaigns.filter(c => c.status === 'sent');
  const totalSent = sent.reduce((s, c) => s + (c.stats?.sent || 0), 0);
  const totalOpened = sent.reduce((s, c) => s + (c.stats?.opened || 0), 0);
  const totalClicked = sent.reduce((s, c) => s + (c.stats?.clicked || 0), 0);
  const openRate = totalSent > 0 ? Math.round((totalOpened / totalSent) * 100) : 0;
  const clickRate = totalSent > 0 ? Math.round((totalClicked / totalSent) * 100) : 0;

  content.innerHTML = `
    <div class="mkt-stats">
      <div class="mkt-stat"><div class="label">Total Campaigns</div><div class="value">${campaigns.length}</div></div>
      <div class="mkt-stat"><div class="label">Emails Sent</div><div class="value" style="color:#16a34a">${totalSent}</div></div>
      <div class="mkt-stat"><div class="label">Avg Open Rate</div><div class="value">${openRate}%</div></div>
      <div class="mkt-stat"><div class="label">Avg Click Rate</div><div class="value">${clickRate}%</div></div>
    </div>
    <table class="campaign-table">
      <thead><tr>
        <th>Campaign</th><th>Status</th><th>Recipients</th><th>Date</th><th>Open Rate</th><th></th>
      </tr></thead>
      <tbody>
        ${campaigns.map(c => {
          const cOpenRate = c.stats?.sent > 0 ? Math.round((c.stats.opened / c.stats.sent) * 100) + '%' : '—';
          const dateStr = c.sentAt ? formatDate(c.sentAt) : c.scheduledFor ? formatDate(c.scheduledFor) : '—';
          return `<tr>
            <td><strong>${esc(c.name)}</strong><br><span style="font-size:.78rem;color:#64748b;">${esc(c.subject)}</span></td>
            <td><span class="camp-status camp-status-${c.status}">${c.status.charAt(0).toUpperCase() + c.status.slice(1)}</span></td>
            <td>${c.stats?.sent || c.recipients?.length || 0}</td>
            <td>${dateStr}</td>
            <td>${cOpenRate}</td>
            <td><button class="btn btn-secondary btn-sm" data-camp-edit="${c.id}">View</button></td>
          </tr>`;
        }).join('')}
        ${campaigns.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:40px;">No campaigns yet. Click "+ New Campaign" to get started.</td></tr>' : ''}
      </tbody>
    </table>
  `;

  content.querySelectorAll('[data-camp-edit]').forEach(btn => {
    btn.addEventListener('click', () => openCampaignComposer(btn.dataset.campEdit));
  });
}

// ── Campaign Composer ──
let composerState = null;

function openCampaignComposer(existingId) {
  if (existingId) {
    const camp = (state.campaigns || []).find(c => c.id === existingId);
    if (camp) {
      composerState = {
        step: 0,
        id: camp.id,
        name: camp.name,
        subject: camp.subject,
        previewText: camp.previewText || '',
        templateId: camp.templateId || '',
        html: camp.html || '',
        recipients: camp.recipients || [],
        status: camp.status,
        isEdit: true,
      };
    } else return;
  } else {
    composerState = {
      step: 0,
      id: null,
      name: '',
      subject: '',
      previewText: '',
      templateId: '',
      html: '',
      recipients: [],
      status: 'draft',
      isEdit: false,
    };
  }
  renderComposer();
}

function renderComposer() {
  const cs = composerState;
  const steps = ['Details', 'Audience', 'Template', 'Edit', 'Review & Send'];

  const stepHeaders = steps.map((s, i) => {
    const cls = i === cs.step ? 'active' : i < cs.step ? 'done' : '';
    return `<div class="composer-step ${cls}"><span class="step-num">${i < cs.step ? '&#10003;' : i + 1}</span>${s}</div>`;
  }).join('');

  let body = '';

  if (cs.step === 0) {
    body = `
      <h3 style="margin-bottom:20px;">Campaign Details</h3>
      <div class="form-group"><label>Campaign Name</label><input type="text" id="campName" value="${esc(cs.name)}" placeholder="e.g. New Strain Drop: Blue Dream"></div>
      <div class="form-group"><label>Subject Line</label><input type="text" id="campSubject" value="${esc(cs.subject)}" placeholder="e.g. Just Dropped: Blue Dream Haze"></div>
      <div class="form-group"><label>Preview Text</label><input type="text" id="campPreview" value="${esc(cs.previewText)}" placeholder="Short preview shown in inbox"></div>
    `;
  } else if (cs.step === 1) {
    const clients = state.clients || [];
    const statuses = ['all', 'active', 'lead', 'prospect'];
    body = `
      <h3 style="margin-bottom:20px;">Select Audience</h3>
      <div class="audience-filter">
        ${statuses.map(s => `<button class="${s === 'all' ? 'active' : ''}" data-aud-filter="${s}">${s === 'all' ? 'All Active' : s.charAt(0).toUpperCase() + s.slice(1)}</button>`).join('')}
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:8px;font-size:.85rem;font-weight:600;cursor:pointer;">
          <input type="checkbox" id="selectAllAud" style="width:18px;height:18px;accent-color:#16a34a;"> Select All
        </label>
      </div>
      <div class="audience-list" id="audienceList">
        ${clients.filter(c => c.status !== 'inactive').map(c => `
          <div class="audience-item" data-aud-status="${c.status}">
            <input type="checkbox" value="${c.id}" class="aud-check" ${cs.recipients.includes(c.id) ? 'checked' : ''}>
            <div>
              <strong>${esc(c.name)}</strong> <span style="color:#64748b;font-size:.8rem;">— ${esc(c.company)}</span>
              <br><span style="font-size:.78rem;color:#94a3b8;">${esc(c.email)} &bull; <span class="status-badge status-${c.status}" style="font-size:.7rem;">${c.status}</span></span>
            </div>
          </div>
        `).join('')}
      </div>
      <p style="margin-top:10px;font-size:.82rem;color:#64748b;"><strong id="audCount">${cs.recipients.length}</strong> recipients selected</p>
    `;
  } else if (cs.step === 2) {
    body = `
      <h3 style="margin-bottom:20px;">Choose a Template</h3>
      <div class="template-grid">
        ${EMAIL_TEMPLATES.map(t => `
          <div class="template-card ${cs.templateId === t.id ? 'selected' : ''}" data-tpl="${t.id}">
            <h5>${esc(t.name)}</h5>
            <p>${esc(t.desc)}</p>
          </div>
        `).join('')}
      </div>
    `;
  } else if (cs.step === 3) {
    body = `
      <h3 style="margin-bottom:12px;">Edit Email Content</h3>
      <div class="editor-toolbar">
        <button onclick="document.execCommand('bold')"><b>B</b></button>
        <button onclick="document.execCommand('italic')"><i>I</i></button>
        <button onclick="document.execCommand('underline')"><u>U</u></button>
        <button onclick="document.execCommand('insertUnorderedList')">List</button>
        <button onclick="document.execCommand('createLink',false,prompt('URL:'))">Link</button>
      </div>
      <div class="editor-split">
        <div class="editor-area" contenteditable="true" id="emailEditor">${cs.html}</div>
        <div class="preview-frame"><iframe id="emailPreview"></iframe></div>
      </div>
    `;
  } else if (cs.step === 4) {
    const tpl = EMAIL_TEMPLATES.find(t => t.id === cs.templateId);
    const recipientNames = (state.clients || []).filter(c => cs.recipients.includes(c.id)).map(c => `${c.name} (${c.email})`);
    const isSent = cs.status === 'sent';
    body = `
      <h3 style="margin-bottom:20px;">Review & Send</h3>
      <div class="review-grid">
        <div class="review-details">
          <div class="review-field"><div class="label">Campaign Name</div><div class="val">${esc(cs.name)}</div></div>
          <div class="review-field"><div class="label">Subject Line</div><div class="val">${esc(cs.subject)}</div></div>
          <div class="review-field"><div class="label">Preview Text</div><div class="val">${esc(cs.previewText) || '<em style="color:#94a3b8">None</em>'}</div></div>
          <div class="review-field"><div class="label">Template</div><div class="val">${tpl ? esc(tpl.name) : 'Custom'}</div></div>
          <div class="review-field"><div class="label">Recipients (${recipientNames.length})</div><div class="val">${recipientNames.length > 0 ? recipientNames.map(n => esc(n)).join('<br>') : '<em style="color:#94a3b8">None selected</em>'}</div></div>
          ${isSent ? '<div class="review-field"><div class="label">Status</div><div class="val"><span class="camp-status camp-status-sent">Sent</span></div></div>' : ''}
        </div>
        <div class="review-preview"><iframe id="reviewPreview"></iframe></div>
      </div>
    `;
  }

  const canGoBack = cs.step > 0;
  const canGoNext = cs.step < 4;
  const isFinalStep = cs.step === 4;
  const isSent = cs.status === 'sent';

  content.innerHTML = `
    <div class="composer">
      <div class="composer-steps">${stepHeaders}</div>
      <div class="composer-body">${body}</div>
      <div class="composer-footer">
        <div>
          <button class="btn btn-secondary" id="compBack" ${!canGoBack ? 'style="visibility:hidden"' : ''}>Back</button>
          <button class="btn btn-secondary" id="compCancel" style="margin-left:8px;">Cancel</button>
        </div>
        <div style="display:flex;gap:8px;">
          ${isFinalStep && !isSent ? `
            <button class="btn btn-secondary" id="compDraft">Save Draft</button>
            <button class="btn btn-secondary" id="compSchedule">Schedule</button>
            <button class="btn btn-primary" id="compSend">Send Now</button>
          ` : canGoNext ? `<button class="btn btn-primary" id="compNext">Next</button>` : `<button class="btn btn-secondary" id="compDone">Done</button>`}
        </div>
      </div>
    </div>
  `;

  // Wire up composer events
  document.getElementById('compCancel')?.addEventListener('click', () => { composerState = null; renderMarketing(); });
  document.getElementById('compBack')?.addEventListener('click', () => { saveComposerStep(); cs.step--; renderComposer(); });
  document.getElementById('compNext')?.addEventListener('click', () => { saveComposerStep(); cs.step++; renderComposer(); });
  document.getElementById('compDone')?.addEventListener('click', () => { composerState = null; renderMarketing(); });
  document.getElementById('compDraft')?.addEventListener('click', () => { saveComposerStep(); saveCampaign('draft'); });
  document.getElementById('compSchedule')?.addEventListener('click', () => { saveComposerStep(); saveCampaign('scheduled'); });
  document.getElementById('compSend')?.addEventListener('click', () => { saveComposerStep(); sendCampaign(); });

  // Step-specific wiring
  if (cs.step === 1) {
    wireAudienceStep();
  } else if (cs.step === 2) {
    content.querySelectorAll('.template-card').forEach(card => {
      card.addEventListener('click', () => {
        content.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        cs.templateId = card.dataset.tpl;
        const tpl = EMAIL_TEMPLATES.find(t => t.id === cs.templateId);
        if (tpl) cs.html = tpl.html;
      });
    });
  } else if (cs.step === 3) {
    const editor = document.getElementById('emailEditor');
    const preview = document.getElementById('emailPreview');
    if (editor && preview) {
      const updatePreview = () => {
        const doc = preview.contentDocument || preview.contentWindow.document;
        doc.open();
        doc.write(editor.innerHTML);
        doc.close();
      };
      editor.addEventListener('input', updatePreview);
      setTimeout(updatePreview, 50);
    }
  } else if (cs.step === 4) {
    const preview = document.getElementById('reviewPreview');
    if (preview) {
      setTimeout(() => {
        const doc = preview.contentDocument || preview.contentWindow.document;
        doc.open();
        doc.write(cs.html);
        doc.close();
      }, 50);
    }
  }
}

function wireAudienceStep() {
  const cs = composerState;
  const checks = document.querySelectorAll('.aud-check');
  const selectAll = document.getElementById('selectAllAud');
  const countEl = document.getElementById('audCount');

  const updateCount = () => {
    cs.recipients = Array.from(document.querySelectorAll('.aud-check:checked')).map(cb => cb.value);
    if (countEl) countEl.textContent = cs.recipients.length;
  };

  checks.forEach(cb => cb.addEventListener('change', () => {
    updateCount();
    if (selectAll) selectAll.checked = cs.recipients.length === checks.length;
  }));

  if (selectAll) {
    selectAll.checked = cs.recipients.length === checks.length;
    selectAll.addEventListener('change', () => {
      const visible = document.querySelectorAll('.audience-item:not([style*="display: none"]) .aud-check');
      visible.forEach(cb => { cb.checked = selectAll.checked; });
      updateCount();
    });
  }

  document.querySelectorAll('[data-aud-filter]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('[data-aud-filter]').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const filter = btn.dataset.audFilter;
      document.querySelectorAll('.audience-item').forEach(item => {
        if (filter === 'all') { item.style.display = ''; }
        else { item.style.display = item.dataset.audStatus === filter ? '' : 'none'; }
      });
    });
  });
}

function saveComposerStep() {
  const cs = composerState;
  if (cs.step === 0) {
    cs.name = document.getElementById('campName')?.value || cs.name;
    cs.subject = document.getElementById('campSubject')?.value || cs.subject;
    cs.previewText = document.getElementById('campPreview')?.value || cs.previewText;
  } else if (cs.step === 1) {
    cs.recipients = Array.from(document.querySelectorAll('.aud-check:checked')).map(cb => cb.value);
  } else if (cs.step === 3) {
    const editor = document.getElementById('emailEditor');
    if (editor) cs.html = editor.innerHTML;
  }
}

function saveCampaign(status) {
  const cs = composerState;
  if (!state.campaigns) state.campaigns = [];

  const campData = {
    name: cs.name,
    subject: cs.subject,
    previewText: cs.previewText,
    templateId: cs.templateId,
    html: cs.html,
    recipients: cs.recipients,
    status: status,
    sentAt: status === 'sent' ? new Date().toISOString().slice(0, 10) : null,
    scheduledFor: status === 'scheduled' ? new Date(Date.now() + 86400000).toISOString().slice(0, 10) : null,
    stats: { sent: 0, opened: 0, clicked: 0 },
  };

  if (cs.id) {
    const existing = state.campaigns.find(c => c.id === cs.id);
    if (existing) Object.assign(existing, campData);
  } else {
    campData.id = c_id();
    state.campaigns.push(campData);
  }
  saveState();
  composerState = null;
  showToast(`Campaign ${status === 'draft' ? 'saved as draft' : 'scheduled'}!`, 'success');
  renderMarketing();
}

// ── Mock Send Engine ──
function sendEmail({ to, subject, html, from }) {
  // Mock implementation — swap with SendGrid API call
  // e.g. sgMail.send({ to, from, subject, html });
  console.log('%c[NovaMind Email Engine] Sending email...', 'color:#22c55e;font-weight:bold;');
  console.log('  To:', to);
  console.log('  From:', from || 'noreply@novamind.ai');
  console.log('  Subject:', subject);
  console.log('  HTML length:', html.length, 'chars');
  return { success: true, messageId: 'mock_' + c_id() };
}

function sendCampaign() {
  const cs = composerState;
  if (!cs.recipients.length) {
    showToast('Please select at least one recipient.', 'error');
    return;
  }
  if (!cs.subject) {
    showToast('Please enter a subject line.', 'error');
    return;
  }

  const recipients = (state.clients || []).filter(c => cs.recipients.includes(c.id));

  console.log('%c[NovaMind Campaign Send]', 'color:#22c55e;font-weight:bold;font-size:14px;');
  console.log('Campaign:', cs.name);
  console.log('Recipients:', recipients.length);
  console.log('---');

  const results = recipients.map(r => {
    return sendEmail({
      to: r.email,
      subject: cs.subject,
      html: cs.html,
      from: 'noreply@novamind.ai',
    });
  });

  const mockOpened = Math.floor(recipients.length * (0.5 + Math.random() * 0.3));
  const mockClicked = Math.floor(mockOpened * (0.3 + Math.random() * 0.3));

  if (!state.campaigns) state.campaigns = [];
  const campData = {
    name: cs.name,
    subject: cs.subject,
    previewText: cs.previewText,
    templateId: cs.templateId,
    html: cs.html,
    recipients: cs.recipients,
    status: 'sent',
    sentAt: new Date().toISOString().slice(0, 10),
    scheduledFor: null,
    stats: { sent: recipients.length, opened: mockOpened, clicked: mockClicked },
  };

  if (cs.id) {
    const existing = state.campaigns.find(c => c.id === cs.id);
    if (existing) Object.assign(existing, campData);
  } else {
    campData.id = c_id();
    state.campaigns.push(campData);
  }

  saveState();
  composerState = null;

  console.log('%c[NovaMind] Campaign sent successfully!', 'color:#22c55e;font-weight:bold;');
  console.log('Total sent:', recipients.length);
  console.log('Message IDs:', results.map(r => r.messageId));

  showToast(`Campaign sent to ${recipients.length} recipient${recipients.length !== 1 ? 's' : ''}!`, 'success');
  renderMarketing();
}

function showToast(message, type) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.className = `toast ${type || 'success'}`;
  toast.innerHTML = `<span>${type === 'success' ? '&#10003;' : '&#9888;'}</span> ${esc(message)}`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// ── Helpers ──
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ── Init ──
navBtns.forEach(b => {
  b.classList.toggle('active', b.dataset.view === state.currentView);
});
render();
</script>
</body>
</html>
